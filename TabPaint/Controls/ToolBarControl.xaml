<UserControl x:Class="TabPaint.Controls.ToolBarControl"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
             xmlns:local="clr-namespace:TabPaint.Controls"
             xmlns:behaviors="clr-namespace:TabPaint.Behaviors"
             mc:Ignorable="d" 
             d:DesignHeight="36" d:DesignWidth="1200">

    <UserControl.Resources>
        <ResourceDictionary>
            <ResourceDictionary.MergedDictionaries>
                <ResourceDictionary Source="pack://application:,,,/Resources/Styles.xaml"/>
            </ResourceDictionary.MergedDictionaries>
        </ResourceDictionary>
    </UserControl.Resources>

    <Border Height="50" Background="{DynamicResource GlassBackgroundMediumBrush}" AllowDrop="True" ClipToBounds="False" SizeChanged="OnToolBarSizeChanged">
        <DockPanel LastChildFill="False" VerticalAlignment="Center" Margin="1,7,1,0" >
            <!-- 基础工具 -->
            <StackPanel x:Name="ExpandedToolsPanel" Orientation="Horizontal" Margin="0,0,0,7" >
                <Button Margin="6,0,1,0" Name="SelectButton" x:FieldModifier="public" ToolTip="{DynamicResource L_ToolBar_Tool_Select}" Click="OnSelectClick_Forward" Style="{StaticResource RoundedMenuButtonStyle}"
                         behaviors:AdvancedToolTipBehavior.EnableAdvancedToolTip="True"
        behaviors:AdvancedToolTipBehavior.DetailedToolTip="{DynamicResource L_ToolBar_Tool_Select_Detail}">
                    <Image Source="{DynamicResource Select_Image}" Width="16" Height="16" />
                </Button>
                <Button Margin="4,0" Name="PenButton" x:FieldModifier="public" ToolTip="{DynamicResource L_ToolBar_Tool_Pen}"  Click="OnPenClick_Forward" Style="{StaticResource RoundedMenuButtonStyle}">

                    <Image Source="{DynamicResource Pencil_Image}" Width="16" Height="16" />
                </Button>
                <Button Margin="4,0" Name="PickColorButton" x:FieldModifier="public" ToolTip="{DynamicResource L_ToolBar_Tool_PickColor}"  Click="OnPickColorClick_Forward" Style="{StaticResource RoundedMenuButtonStyle}">
                    <Image Source="{DynamicResource Pick_Colour_Image}" Width="16" Height="16" />
                </Button>
                <Button Margin="4,0" Name="EraserButton" x:FieldModifier="public" ToolTip="{DynamicResource L_ToolBar_Tool_Eraser}" Click="OnEraserClick_Forward" Style="{StaticResource RoundedMenuButtonStyle}">
                    <Image Source="{DynamicResource Eraser_Image}" Width="16" Height="16" />
                </Button>
                <Button Margin="4,0" Name="FillButton" x:FieldModifier="public" ToolTip="{DynamicResource L_ToolBar_Tool_Fill}" Click="OnFillClick_Forward" Style="{StaticResource RoundedMenuButtonStyle}">
                    <Image Source="{DynamicResource Fill_Bucket_Image}" Width="16" Height="16" />
                </Button>
                <Button Margin="4,0,6,0" Name="TextButton" x:FieldModifier="public" ToolTip="{DynamicResource L_ToolBar_Tool_Text}" Click="OnTextClick_Forward" Style="{StaticResource RoundedMenuButtonStyle}">
                    <Image Source="{DynamicResource Text_Image}" Width="16" Height="16" />
                </Button>
            </StackPanel>

            <!-- 2. 折叠模式：工具集合菜单 (默认隐藏) -->
            <Grid x:Name="CollapsedToolsPanel" Visibility="Collapsed" Margin="6,0,6,7">
                <ToggleButton x:Name="ToolsMenuToggle" ToolTip="{DynamicResource L_ToolBar_Tool_DrawTools}" Style="{StaticResource DropDownButtonStyle}">
                    <Image x:Name="CurrentToolIcon" Source="{DynamicResource ColorPickerPencil_Image}" Width="16" Height="16" />
                </ToggleButton>

                <Popup IsOpen="{Binding IsChecked, ElementName=ToolsMenuToggle, Mode=TwoWay}"
           PlacementTarget="{Binding ElementName=ToolsMenuToggle}" 
           Placement="Bottom" AllowsTransparency="True" PopupAnimation="None" 
           StaysOpen="{Binding IsMouseOver, ElementName=ToolsMenuToggle}">
                    <Border Background="{DynamicResource ControlBackgroundBrush}" BorderBrush="{DynamicResource BorderBrush}" BorderThickness="1" CornerRadius="4" Margin="3,0" Padding="2">
                        <StackPanel x:Name="CollapsedMenuItems">
                            <MenuItem Header="{DynamicResource L_ToolBar_Tool_Select}" Tag="SelectTool" Style="{StaticResource SubMenuItemStyle}" Click="OnSelectClick_Forward">
                                <MenuItem.Icon>
                                    <Image Source="{DynamicResource Select_Image}" Width="16" Height="16" />
                                </MenuItem.Icon>
                            </MenuItem>
                            <MenuItem Header="{DynamicResource L_ToolBar_Tool_Pen}" Tag="PenTool" Style="{StaticResource SubMenuItemStyle}" Click="OnPenClick_Forward">
                                <MenuItem.Icon>
                                    <Image Source="{DynamicResource Pencil_Image}" Width="16" Height="16" />
                                </MenuItem.Icon>
                            </MenuItem>
                            <MenuItem Header="{DynamicResource L_ToolBar_Tool_Eyedropper}" Tag="EyedropperTool" Style="{StaticResource SubMenuItemStyle}" Click="OnPickColorClick_Forward">
                                <MenuItem.Icon>
                                    <Image Source="{DynamicResource Pick_Colour_Image}" Width="16" Height="16" />
                                </MenuItem.Icon>
                            </MenuItem>
                            <MenuItem Header="{DynamicResource L_ToolBar_Tool_Eraser}" Tag="EraserTool" Style="{StaticResource SubMenuItemStyle}" Click="OnEraserClick_Forward">
                                <MenuItem.Icon>
                                    <Image Source="{DynamicResource Eraser_Image}" Width="16" Height="16" />
                                </MenuItem.Icon>
                            </MenuItem>
                            <MenuItem Header="{DynamicResource L_ToolBar_Tool_Fill}" Tag="FillTool" Style="{StaticResource SubMenuItemStyle}" Click="OnFillClick_Forward">
                                <MenuItem.Icon>
                                    <Image Source="{DynamicResource Fill_Bucket_Image}" Width="16" Height="16" />
                                </MenuItem.Icon>
                            </MenuItem>
                            <MenuItem Header="{DynamicResource L_ToolBar_Tool_Text}" Tag="TextTool" Style="{StaticResource SubMenuItemStyle}" Click="OnTextClick_Forward">
                                <MenuItem.Icon>
                                    <Image Source="{DynamicResource Text_Image}" Width="16" Height="16" />
                                </MenuItem.Icon>
                            </MenuItem>
                        </StackPanel>
                    </Border>
                </Popup>
            </Grid>

            <!-- 画刷菜单 (Split Button) -->
            <Grid Margin="0,0,0,7">
                <!-- 
                   外层 Border：负责整体轮廓、选中状态(蓝色边框) 和 整体悬浮背景 
                   注意：CornerRadius 设为 4，与普通工具按钮一致
                -->
                <Border x:Name="BrushSplitButtonBorder" 
                        CornerRadius="4" 
                        BorderThickness="1" 
                        Background="Transparent" 
                        BorderBrush="Transparent">

                    <!-- 定义外层 Border 的悬浮样式 -->
                    <Border.Style>
                        <Style TargetType="Border">
                            <Style.Triggers>
                                <!-- 当鼠标悬浮在整个 Border 范围内时，改变背景色 -->
                                <Trigger Property="IsMouseOver" Value="True">
                                    <Setter Property="Background" Value="{DynamicResource ControlMouseOverBackgroundBrush}"/>
                                </Trigger>
                            </Style.Triggers>
                        </Style>
                    </Border.Style>

                    <StackPanel Orientation="Horizontal">
                        <!-- 左半部分：应用透明样式 -->
                        <Button x:Name="BrushMainButton" Click="OnBrushMainButtonClick" 
                                ToolTip="{DynamicResource L_ToolBar_Brush}"
                                Style="{StaticResource TransparentInnerButtonStyle}"
                                Width="26" Height="30">
                            <ContentControl x:Name="CurrentBrushIconHost" IsHitTestVisible="False" Width="16" Height="16">
                                <Image Source="{DynamicResource Brush_Image}" Width="16" Height="16"/>
                            </ContentControl>
                        </Button>

                        <!-- 分割线：只有悬浮时才显现比较好看，或者一直显示淡淡的 -->
                        <Border Width="1" Background="{DynamicResource BorderBrush}" Margin="0,4" Opacity="0.5"/>

                        <!-- 右半部分：应用透明样式 -->
                        <ToggleButton x:Name="BrushToggle" 
                                      Style="{StaticResource TransparentInnerButtonStyle}"
                                      Width="16" Height="30">
                            <Path Data="M0,0 L3.5,4 L7,0" Stroke="{DynamicResource IconFillBrush}" StrokeThickness="1" 
                                  VerticalAlignment="Center" HorizontalAlignment="Center"/>
                        </ToggleButton>
                    </StackPanel>
                </Border>

                <!-- Popup 部分保持不变 ... -->
                <Popup x:Name="SubMenuPopupBrush" IsOpen="{Binding IsChecked, ElementName=BrushToggle, Mode=TwoWay}"
                       PlacementTarget="{Binding ElementName=BrushSplitButtonBorder}" 
                       Placement="Bottom" AllowsTransparency="True" PopupAnimation="None" 
                       StaysOpen="{Binding IsMouseOver, ElementName=BrushToggle}">
                    <!-- ... 内部菜单内容不变 ... -->
                    <Border Name="SubmenuBorderBrush" Background="{DynamicResource ControlBackgroundBrush}" BorderBrush="{DynamicResource BorderBrush}" BorderThickness="1" CornerRadius="4" Margin="3,0" Padding="2">
                        <StackPanel>
                            <MenuItem Header="{DynamicResource L_ToolBar_Brush_Round}" Style="{StaticResource SubMenuItemStyle}" Click="OnBrushStyleClick_Forward" Tag="Round">
                                <MenuItem.Icon>
                                    <Path Data="{DynamicResource Brush_Normal_Image}" Stretch="Uniform" Fill="{DynamicResource IconFillBrush}" Width="16" Height="16"/>
                                </MenuItem.Icon>
                            </MenuItem>
                            <MenuItem Header="{DynamicResource L_ToolBar_Brush_Square}" Style="{StaticResource SubMenuItemStyle}" Click="OnBrushStyleClick_Forward" Tag="Square">
                                <MenuItem.Icon>
                                    <Path Data="{DynamicResource Brush_Rect_Image}" Stretch="Uniform" Fill="{DynamicResource IconFillBrush}" Width="16" Height="16"/>
                                </MenuItem.Icon>
                            </MenuItem>
                            <MenuItem Header="{DynamicResource L_ToolBar_Brush_Brush}" Style="{StaticResource SubMenuItemStyle}" Click="OnBrushStyleClick_Forward" Tag="Brush">
                                <MenuItem.Icon>
                                    <Path Data="{DynamicResource Brush_Normal_Image}" Stretch="Uniform" Fill="{DynamicResource IconFillBrush}" Width="16" Height="16"/>
                                </MenuItem.Icon>
                            </MenuItem>
                            <MenuItem Header="{DynamicResource L_ToolBar_Brush_Calligraphy}" Style="{StaticResource SubMenuItemStyle}" Click="OnBrushStyleClick_Forward" Tag="Calligraphy">
                                <MenuItem.Icon>
                                    <Image Source="{DynamicResource Brush_Image}" Width="16" Height="16"/>
                                </MenuItem.Icon>
                            </MenuItem>
                            <MenuItem Header="{DynamicResource L_ToolBar_Brush_Spray}" Style="{StaticResource SubMenuItemStyle}" Click="OnBrushStyleClick_Forward" Tag="Spray">
                                <MenuItem.Icon>
                                    <Path Data="{DynamicResource Paint_Spray_Image}" Stretch="Uniform" Fill="{DynamicResource IconFillBrush}" Width="16" Height="16"/>
                                </MenuItem.Icon>
                            </MenuItem>
                            <Separator Style="{StaticResource MenuSeparator}"/>
                            <MenuItem Header="{DynamicResource L_ToolBar_Brush_Crayon}" Style="{StaticResource SubMenuItemStyle}" Click="OnBrushStyleClick_Forward" Tag="Crayon">
                                <MenuItem.Icon>
                                    <Path Data="{DynamicResource Crayon_Image}" Stretch="Uniform" Fill="{DynamicResource IconFillBrush}" Width="16" Height="16"/>
                                </MenuItem.Icon>
                            </MenuItem>
                            <MenuItem Header="{DynamicResource L_ToolBar_Brush_Watercolor}" Style="{StaticResource SubMenuItemStyle}" Click="OnBrushStyleClick_Forward" Tag="Watercolor">
                                <MenuItem.Icon>
                                    <Path Data="{DynamicResource Watercolor_Image}" Stretch="Uniform" Fill="{DynamicResource IconFillBrush}" Width="16" Height="16"/>
                                </MenuItem.Icon>
                            </MenuItem>
                            <MenuItem Header="{DynamicResource L_ToolBar_Brush_Highlighter}" Style="{StaticResource SubMenuItemStyle}" Click="OnBrushStyleClick_Forward" Tag="Highlighter">
                                <MenuItem.Icon>
                                    <Image Source="{DynamicResource Highlighter_Image}" Width="16" Height="16"/>
                                </MenuItem.Icon>
                            </MenuItem>
                            <MenuItem Header="{DynamicResource L_ToolBar_Brush_Mosaic}" Style="{StaticResource SubMenuItemStyle}" Click="OnBrushStyleClick_Forward" Tag="Mosaic">
                                <MenuItem.Icon>
                                    <Path Data="{DynamicResource Mosaic_Image}" Stretch="Uniform" Fill="{DynamicResource IconFillBrush}" Width="16" Height="16"/>
                                </MenuItem.Icon>
                            </MenuItem>
                        </StackPanel>
                    </Border>
                </Popup>
            </Grid>

            <!-- 形状菜单 (Split Button) -->
            <Grid Margin="4,0,4,7">
                <Border x:Name="ShapeSplitButtonBorder" 
                        CornerRadius="4" 
                        BorderThickness="1" 
                        Background="Transparent" 
                        BorderBrush="Transparent">

                    <Border.Style>
                        <Style TargetType="Border">
                            <Style.Triggers>
                                <Trigger Property="IsMouseOver" Value="True">
                                    <Setter Property="Background" Value="{DynamicResource ControlMouseOverBackgroundBrush}"/>
                                </Trigger>
                            </Style.Triggers>
                        </Style>
                    </Border.Style>

                    <StackPanel Orientation="Horizontal">
                        <Button x:Name="ShapeMainButton" Click="OnShapeMainButtonClick" 
                                ToolTip="{DynamicResource L_ToolBar_Shape}"
                                Style="{StaticResource TransparentInnerButtonStyle}"
                                Width="26" Height="30">
                            <ContentControl x:Name="CurrentShapeIconHost" IsHitTestVisible="False" Width="16" Height="16">
                                <Path Data="{DynamicResource Shapes_Image}" Stretch="Uniform" Fill="Transparent" 
                                      Stroke="{DynamicResource IconFillBrush}" StrokeThickness="1.5" 
                                      StrokeLineJoin="Round" StrokeEndLineCap="Round" StrokeStartLineCap="Round" 
                                      Width="16" Height="16"/>
                            </ContentControl>
                        </Button>

                        <Border Width="1" Background="{DynamicResource BorderBrush}" Margin="0,4" Opacity="0.5"/>

                        <ToggleButton x:Name="ShapeToggle" 
                                      Style="{StaticResource TransparentInnerButtonStyle}"
                                      Width="16" Height="30">
                            <Path Data="M0,0 L3.5,4 L7,0" Stroke="{DynamicResource IconFillBrush}" StrokeThickness="1" 
                                  VerticalAlignment="Center" HorizontalAlignment="Center"/>
                        </ToggleButton>
                    </StackPanel>
                </Border>

                <!-- Popup 保持不变 ... -->
                <Popup x:Name="SubMenuPopupShape" IsOpen="{Binding IsChecked, ElementName=ShapeToggle, Mode=TwoWay}"
           PlacementTarget="{Binding ElementName=ShapeSplitButtonBorder}" Placement="Bottom" AllowsTransparency="True" PopupAnimation="None" 
           StaysOpen="{Binding IsMouseOver, ElementName=ShapeToggle}">
                    <Border Name="SubmenuBorderShape" Background="{DynamicResource ControlBackgroundBrush}" BorderBrush="{DynamicResource BorderBrush}" BorderThickness="1" CornerRadius="4" Margin="3,0" Padding="2">
                        <StackPanel>
                            <MenuItem Header="{DynamicResource L_ToolBar_Shape_Rectangle}" Style="{StaticResource SubMenuItemStyle}" Click="OnShapeStyleClick_Forward" Tag="Rectangle">
                                <MenuItem.Icon>
                                    <Path x:Name="RectIcon" x:FieldModifier="public" Data="{DynamicResource Icon_Shape_Rectangle}" Stretch="Uniform" Fill="Transparent"  Stroke="{DynamicResource IconFillBrush}"  StrokeThickness="1.5" StrokeLineJoin="Round"  StrokeEndLineCap="Round"   StrokeStartLineCap="Round" Width="16" Height="16"/>
                                </MenuItem.Icon>
                            </MenuItem>

                            <MenuItem Header="{DynamicResource L_ToolBar_Shape_RoundedRectangle}" Style="{StaticResource SubMenuItemStyle}" Click="OnShapeStyleClick_Forward" Tag="RoundedRectangle">
                                <MenuItem.Icon>
                                    <Path x:Name="RoundedRectIcon" x:FieldModifier="public" Data="{DynamicResource Icon_Shape_RoundedRect}" Stretch="Uniform" Fill="Transparent"  Stroke="{DynamicResource IconFillBrush}"  StrokeThickness="1.5" StrokeLineJoin="Round"  StrokeEndLineCap="Round"   StrokeStartLineCap="Round" Width="16" Height="16"/>
                                </MenuItem.Icon>
                            </MenuItem>

                            <MenuItem Header="{DynamicResource L_ToolBar_Shape_Ellipse}" Style="{StaticResource SubMenuItemStyle}" Click="OnShapeStyleClick_Forward" Tag="Ellipse">
                                <MenuItem.Icon>
                                    <Path x:Name="EllipseIcon" x:FieldModifier="public" Data="{DynamicResource Icon_Shape_Ellipse}" Stretch="Uniform" Fill="Transparent"  Stroke="{DynamicResource IconFillBrush}"  StrokeThickness="1.5" StrokeLineJoin="Round"  StrokeEndLineCap="Round"   StrokeStartLineCap="Round" Width="16" Height="16"/>
                                </MenuItem.Icon>
                            </MenuItem>

                            <MenuItem Header="{DynamicResource L_ToolBar_Shape_Line}" Style="{StaticResource SubMenuItemStyle}" Click="OnShapeStyleClick_Forward" Tag="Line">
                                <MenuItem.Icon>
                                    <Path x:Name="LineIcon" x:FieldModifier="public" Data="{DynamicResource Icon_Shape_Line}" Stretch="Uniform" Fill="Transparent"  Stroke="{DynamicResource IconFillBrush}"  StrokeThickness="1.5" StrokeLineJoin="Round"  StrokeEndLineCap="Round"   StrokeStartLineCap="Round" Width="16" Height="16"/>
                                </MenuItem.Icon>
                            </MenuItem>

                            <MenuItem Header="{DynamicResource L_ToolBar_Shape_Arrow}" Style="{StaticResource SubMenuItemStyle}" Click="OnShapeStyleClick_Forward" Tag="Arrow">
                                <MenuItem.Icon>
                                    <Path x:Name="ArrowIcon" x:FieldModifier="public" Data="{DynamicResource Icon_Shape_Arrow}" Stretch="Uniform" Fill="Transparent"  Stroke="{DynamicResource IconFillBrush}"  StrokeThickness="1.5" StrokeLineJoin="Round"  StrokeEndLineCap="Round"   StrokeStartLineCap="Round" Width="16" Height="16"/>
                                </MenuItem.Icon>
                            </MenuItem>
                        </StackPanel>
                    </Border>
                </Popup>
            </Grid>

            <Border DockPanel.Dock="Left" Width="1" Background="{DynamicResource BorderMediumBrush}" Margin="2,4,2,11"/>
            <Button Margin="2,0,0,7" Name="CutImage" x:FieldModifier="public" ToolTip="{DynamicResource L_ToolBar_Crop}" Click="CropMenuItem_Click_Forward" Style="{StaticResource RoundedMenuButtonStyle}">
                <Path x:Name="CutImageIcon" x:FieldModifier="public" Data="{DynamicResource Cut_Selection_Image}"  Stretch="Uniform"  Fill="{DynamicResource IconFillBrush}" Width="16" Height="16"/>
            </Button>

            <!-- 旋转/翻转菜单 -->
            <Grid Margin="0,0,0,7">
                <ToggleButton x:Name="RotateFlipMenuToggle" x:FieldModifier="public" ToolTip="{DynamicResource L_ToolBar_RotateFlip}" Style="{StaticResource DropDownButtonStyle}">
                    <Image Source="{DynamicResource Spin180_Image}" Width="16" Height="16"/>
                </ToggleButton>

                <Popup x:Name="SubMenuPopup" IsOpen="{Binding IsChecked, ElementName=RotateFlipMenuToggle, Mode=TwoWay}"
           PlacementTarget="{Binding ElementName=RotateFlipMenuToggle}" Placement="Bottom" AllowsTransparency="True" PopupAnimation="None" StaysOpen="{Binding IsMouseOver, ElementName=RotateFlipMenuToggle}">
                    <Border Name="SubmenuBorder" Background="{DynamicResource ControlBackgroundBrush}" BorderBrush="{DynamicResource BorderBrush}" BorderThickness="1" CornerRadius="4" Margin="3,0" Padding="2">
                        <StackPanel>
                            <MenuItem Header="{DynamicResource L_ToolBar_Rotate_Left}" Style="{StaticResource SubMenuItemStyle}" Click="OnRotateLeftClick_Forward">
                                <MenuItem.Icon>
                                    <Path Data="{DynamicResource Rotate_Left_Image}" Stretch="Uniform" Fill="{DynamicResource IconFillBrush}" Width="16" Height="16"/>
                                </MenuItem.Icon>
                            </MenuItem>

                            <MenuItem Header="{DynamicResource L_ToolBar_Rotate_Right}" Style="{StaticResource SubMenuItemStyle}" Click="OnRotateRightClick_Forward">
                                <MenuItem.Icon>
                                    <Path Data="{DynamicResource Rotate_Right_Image}" Stretch="Uniform" Fill="{DynamicResource IconFillBrush}" Width="16" Height="16"/>
                                </MenuItem.Icon>
                            </MenuItem>

                            <MenuItem Header="{DynamicResource L_ToolBar_Rotate_180}" Style="{StaticResource SubMenuItemStyle}" Click="OnRotate180Click_Forward">
                                <MenuItem.Icon>
                                    <Image Source="{DynamicResource Spin180_Image}" Width="16" Height="16"/>
                                </MenuItem.Icon>
                            </MenuItem>

                            <Separator Style="{StaticResource MenuSeparator}"/>

                            <MenuItem Header="{DynamicResource L_ToolBar_Flip_Vertical}" Style="{StaticResource SubMenuItemStyle}" Click="OnFlipVerticalClick_Forward">
                                <MenuItem.Icon>
                                    <Path Data="{DynamicResource Flip_Vertical_Image}" Stretch="Uniform" Fill="Transparent"  Stroke="{DynamicResource IconFillBrush}"  StrokeThickness="1" StrokeLineJoin="Round"  StrokeEndLineCap="Round"   StrokeStartLineCap="Round" Width="16" Height="16"/>
                                </MenuItem.Icon>
                            </MenuItem>

                            <MenuItem Header="{DynamicResource L_ToolBar_Flip_Horizontal}" Style="{StaticResource SubMenuItemStyle}" Click="OnFlipHorizontalClick_Forward">
                                <MenuItem.Icon>
                                    <Path Data="{DynamicResource Flip_Horizontal_Image}" Stretch="Uniform" Fill="Transparent"  Stroke="{DynamicResource IconFillBrush}"  StrokeThickness="1" StrokeLineJoin="Round"  StrokeEndLineCap="Round"   StrokeStartLineCap="Round" Width="16" Height="16"/>
                                </MenuItem.Icon>
                            </MenuItem>
                        </StackPanel>
                    </Border>
                </Popup>
            </Grid>
            <Border DockPanel.Dock="Left" Width="1" Background="{DynamicResource BorderMediumBrush}" Margin="2,4,2,11"/>

            <Button ToolTip="{DynamicResource L_ToolBar_CustomColor}" 
        Click="OnCustomColorClick_Forward" 
        Margin="5,0,2,7" 
        Padding="0" 
        Style="{StaticResource RoundedMenuButtonStyle}" 
        HorizontalAlignment="Left" 
        VerticalAlignment="Top" 
        HorizontalContentAlignment="Left">

                <Viewbox Width="36" Height="36">
                    <Grid Width="100" Height="100">
                        <Grid Margin="2,-7,0,0">
                            <Grid.Clip>
                                <EllipseGeometry Center="45,55" RadiusX="38" RadiusY="38"/>
                            </Grid.Clip>

                            <Grid>
                                <Grid.RenderTransform>
                                    <MatrixTransform Matrix="1,0,0,1,45,55"/>
                                </Grid.RenderTransform>
                                <Grid.Effect>
                                    <BlurEffect Radius="16" KernelType="Gaussian"/>
                                </Grid.Effect>

                                <Path Fill="#FF0000" Data="M0,0 L0,-50 A50,50 0 0,1 43.3,-25 Z">
                                    <Path.RenderTransform>
                                        <RotateTransform Angle="-30"/>
                                    </Path.RenderTransform>
                                </Path>
                                <Path Fill="#FFFF00" Data="M0,0 L0,-50 A50,50 0 0,1 43.3,-25 Z">
                                    <Path.RenderTransform>
                                        <RotateTransform Angle="30"/>
                                    </Path.RenderTransform>
                                </Path>
                                <Path Fill="#00FF00" Data="M0,0 L0,-50 A50,50 0 0,1 43.3,-25 Z">
                                    <Path.RenderTransform>
                                        <RotateTransform Angle="90"/>
                                    </Path.RenderTransform>
                                </Path>
                                <Path Fill="#00FFFF" Data="M0,0 L0,-50 A50,50 0 0,1 43.3,-25 Z">
                                    <Path.RenderTransform>
                                        <RotateTransform Angle="150"/>
                                    </Path.RenderTransform>
                                </Path>
                                <Path Fill="#0000FF" Data="M0,0 L0,-50 A50,50 0 0,1 43.3,-25 Z">
                                    <Path.RenderTransform>
                                        <RotateTransform Angle="210"/>
                                    </Path.RenderTransform>
                                </Path>
                                <Path Fill="#FF00FF" Data="M0,0 L0,-50 A50,50 0 0,1 43.3,-25 Z">
                                    <Path.RenderTransform>
                                        <RotateTransform Angle="270"/>
                                    </Path.RenderTransform>
                                </Path>
                            </Grid>

                            <Path IsHitTestVisible="False">
                                <Path.Data>
                                    <EllipseGeometry Center="45,55" RadiusX="38" RadiusY="38"/>
                                </Path.Data>
                                <Path.Fill>
                                    <!-- 高光渐变保持白色，因为是光照效果 -->
                                    <RadialGradientBrush Center="0.5,0.5" GradientOrigin="0.5,0.5" RadiusX="0.5" RadiusY="0.5">
                                        <GradientStop Color="#FFFFFFFF" Offset="0" />
                                        <GradientStop Color="#80FFFFFF" Offset="0.4" />
                                        <GradientStop Color="#00FFFFFF" Offset="1" />
                                    </RadialGradientBrush>
                                </Path.Fill>
                            </Path>
                        </Grid>
                        <Grid>
                            <Path Fill="{DynamicResource ControlBackgroundBrush}" Stroke="{DynamicResource BorderDarkBrush}" StrokeThickness="2">
                                <Path.Data>
                                    <EllipseGeometry Center="72,28" RadiusX="14" RadiusY="14"/>
                                </Path.Data>
                            </Path>
                            <Path Data="M72,20 L72,36 M64,28 L80,28" Stroke="{DynamicResource IconFillBrush}" StrokeThickness="2" StrokeStartLineCap="Round" StrokeEndLineCap="Round"/>
                        </Grid>
                    </Grid>
                </Viewbox>
            </Button>

            <Button x:Name="ColorBtn1" x:FieldModifier="public" Width="30" Height="30" Margin="2,2,2,9" ToolTip="{DynamicResource L_ToolBar_Color1}" Click="OnColorOneClick_Forward" Tag="True" Style="{StaticResource ColorCircleButtonStyle}" Background="{Binding ForegroundBrush, Mode=TwoWay}">
            </Button>
            <Button x:Name="ColorBtn2" x:FieldModifier="public" Width="30" Height="30" Margin="2,0,10,7" ToolTip="{DynamicResource L_ToolBar_Color2}" Click="OnColorTwoClick_Forward" Style="{StaticResource ColorCircleButtonStyle}" Background="{Binding BackgroundBrush, Mode=TwoWay}">
            </Button>

            <StackPanel>
                <UniformGrid Columns="11" HorizontalAlignment="Left" VerticalAlignment="Top" x:Name="BasicColorsGrid">

                    <!-- Row 2: 鲜艳/标准色系 (Vibrant & Primary) -->
                    <Button Style="{StaticResource ColorSwatch}" Background="#FFFFFF" Click="Swatch_Click" ToolTip="{DynamicResource L_ToolBar_Color_White}"/>
                    <Button Style="{StaticResource ColorSwatch}" Background="#C0C0C0" Click="Swatch_Click" ToolTip="{DynamicResource L_ToolBar_Color_Silver}"/>
                    <Button Style="{StaticResource ColorSwatch}" Background="#FF0000" Click="Swatch_Click" ToolTip="{DynamicResource L_ToolBar_Color_Red}"/>
                    <Button Style="{StaticResource ColorSwatch}" Background="#FF8000" Click="Swatch_Click" ToolTip="{DynamicResource L_ToolBar_Color_Orange}"/>
                    <Button Style="{StaticResource ColorSwatch}" Background="#FFFF00" Click="Swatch_Click" ToolTip="{DynamicResource L_ToolBar_Color_Yellow}"/>
                    <Button Style="{StaticResource ColorSwatch}" Background="#00FF00" Click="Swatch_Click" ToolTip="{DynamicResource L_ToolBar_Color_Lime}"/>
                    <Button Style="{StaticResource ColorSwatch}" Background="#00FFFF" Click="Swatch_Click" ToolTip="{DynamicResource L_ToolBar_Color_Cyan}"/>
                    <Button Style="{StaticResource ColorSwatch}" Background="#0080FF" Click="Swatch_Click" ToolTip="{DynamicResource L_ToolBar_Color_SkyBlue}"/>
                    <Button Style="{StaticResource ColorSwatch}" Background="#8000FF" Click="Swatch_Click" ToolTip="{DynamicResource L_ToolBar_Color_Violet}"/>
                    <Button Style="{StaticResource ColorSwatch}" Background="#FF00FF" Click="Swatch_Click" ToolTip="{DynamicResource L_ToolBar_Color_Magenta}"/>
                    <Button Style="{StaticResource ColorSwatch}" Background="#D2691E" Click="Swatch_Click" ToolTip="{DynamicResource L_ToolBar_Color_Chocolate}"/>

                    <!-- Row 3: 中深/饱和色系 (Deep & Saturated) -->
                    <Button Style="{StaticResource ColorSwatch}" Background="#000000" Click="Swatch_Click" ToolTip="{DynamicResource L_ToolBar_Color_Black}"/>
                    <Button Style="{StaticResource ColorSwatch}" Background="#808080" Click="Swatch_Click" ToolTip="{DynamicResource L_ToolBar_Color_Gray}"/>
                    <Button Style="{StaticResource ColorSwatch}" Background="#CC0000" Click="Swatch_Click" ToolTip="{DynamicResource L_ToolBar_Color_DarkRed}"/>
                    <Button Style="{StaticResource ColorSwatch}" Background="#CC6600" Click="Swatch_Click" ToolTip="{DynamicResource L_ToolBar_Color_DarkOrange}"/>
                    <Button Style="{StaticResource ColorSwatch}" Background="#FFD700" Click="Swatch_Click" ToolTip="{DynamicResource L_ToolBar_Color_Gold}"/>
                    <Button Style="{StaticResource ColorSwatch}" Background="#008000" Click="Swatch_Click" ToolTip="{DynamicResource L_ToolBar_Color_Green}"/>
                    <Button Style="{StaticResource ColorSwatch}" Background="#008080" Click="Swatch_Click" ToolTip="{DynamicResource L_ToolBar_Color_Teal}"/>
                    <Button Style="{StaticResource ColorSwatch}" Background="#0000FF" Click="Swatch_Click" ToolTip="{DynamicResource L_ToolBar_Color_Blue}"/>
                    <Button Style="{StaticResource ColorSwatch}" Background="#800080" Click="Swatch_Click" ToolTip="{DynamicResource L_ToolBar_Color_Purple}"/>
                    <Button Style="{StaticResource ColorSwatch}" Background="#C71585" Click="Swatch_Click" ToolTip="{DynamicResource L_ToolBar_Color_Maroon}"/>
                    <Button Style="{StaticResource ColorSwatch}" Background="#A0522D" Click="Swatch_Click" ToolTip="{DynamicResource L_ToolBar_Color_Sienna}"/>

                </UniformGrid>
            </StackPanel>
            <Border  x:Name="RightColorSeperator" DockPanel.Dock="Left" Width="1" Background="{DynamicResource BorderMediumBrush}" Margin="10,4,0,11"/>
        </DockPanel>
    </Border>
</UserControl>

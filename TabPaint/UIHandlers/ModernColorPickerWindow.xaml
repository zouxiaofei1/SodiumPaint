<Window x:Class="TabPaint.ModernColorPickerWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        Title="编辑颜色" Height="620" Width="740"
        WindowStartupLocation="CenterOwner"
        ResizeMode="NoResize"
        Background="Transparent"
        WindowStyle="None"
        AllowsTransparency="True">
	<!-- 注意：这里移除了 Window_MouseDown -->

	<WindowChrome.WindowChrome>
		<WindowChrome CaptionHeight="0" ResizeBorderThickness="5" CornerRadius="8" GlassFrameThickness="0"/>
	</WindowChrome.WindowChrome>

	<Window.Resources>

		<Style x:Key="FluentTextBox" TargetType="{x:Type TextBox}">
			<Setter Property="Background" Value="#2D2D2D"/>
			<Setter Property="Foreground" Value="White"/>
			<Setter Property="BorderThickness" Value="0,0,0,1"/>
			<Setter Property="BorderBrush" Value="#555"/>
			<Setter Property="Padding" Value="8,6"/>
			<Setter Property="FontSize" Value="14"/>
			<Setter Property="Template">
				<Setter.Value>
					<ControlTemplate TargetType="{x:Type TextBox}">
						<Border x:Name="border" Background="{TemplateBinding Background}"
                                BorderBrush="{TemplateBinding BorderBrush}"
                                BorderThickness="{TemplateBinding BorderThickness}"
                                CornerRadius="4">
							<ScrollViewer x:Name="PART_ContentHost" Focusable="false" HorizontalScrollBarVisibility="Hidden" VerticalScrollBarVisibility="Hidden"/>
						</Border>
						<ControlTemplate.Triggers>
							<Trigger Property="IsMouseOver" Value="true">
								<Setter Property="Background" TargetName="border" Value="#353535"/>
								<Setter Property="BorderBrush" TargetName="border" Value="#888"/>
							</Trigger>
							<Trigger Property="IsKeyboardFocused" Value="true">
								<Setter Property="Background" TargetName="border" Value="#202020"/>
								<Setter Property="BorderBrush" TargetName="border" Value="#60CDFF"/>
								<Setter Property="BorderThickness" TargetName="border" Value="0,0,0,2"/>
							</Trigger>
						</ControlTemplate.Triggers>
					</ControlTemplate>
				</Setter.Value>
			</Setter>
		</Style>

		<Style x:Key="FluentButton" TargetType="{x:Type Button}">
			<Setter Property="Background" Value="#333"/>
			<Setter Property="Foreground" Value="White"/>
			<Setter Property="BorderThickness" Value="0"/>
			<Setter Property="FontSize" Value="14"/>
			<Setter Property="Padding" Value="15,6"/>
			<Setter Property="Template">
				<Setter.Value>
					<ControlTemplate TargetType="{x:Type Button}">
						<Border x:Name="border" Background="{TemplateBinding Background}" CornerRadius="4">
							<ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
						</Border>
						<ControlTemplate.Triggers>
							<Trigger Property="IsMouseOver" Value="True">
								<Setter Property="Background" TargetName="border" Value="#3F3F3F"/>
							</Trigger>
							<Trigger Property="IsPressed" Value="True">
								<Setter Property="Background" TargetName="border" Value="#2A2A2A"/>
								<Setter Property="RenderTransform">
									<Setter.Value>
										<ScaleTransform ScaleX="0.98" ScaleY="0.98" CenterX="50" CenterY="15"/>
									</Setter.Value>
								</Setter>
							</Trigger>
						</ControlTemplate.Triggers>
					</ControlTemplate>
				</Setter.Value>
			</Setter>
		</Style>

		<Style x:Key="FluentAccentButton" TargetType="{x:Type Button}" BasedOn="{StaticResource FluentButton}">
			<Setter Property="Background" Value="#60CDFF"/>
			<Setter Property="Foreground" Value="#000"/>
			<Setter Property="FontWeight" Value="SemiBold"/>
			<Setter Property="Template">
				<Setter.Value>
					<ControlTemplate TargetType="{x:Type Button}">
						<Border x:Name="border" Background="{TemplateBinding Background}" CornerRadius="4">
							<ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
						</Border>
						<ControlTemplate.Triggers>
							<Trigger Property="IsMouseOver" Value="True">
								<Setter Property="Background" TargetName="border" Value="#78D5FF"/>
							</Trigger>
							<Trigger Property="IsPressed" Value="True">
								<Setter Property="Background" TargetName="border" Value="#50B8EA"/>
							</Trigger>
						</ControlTemplate.Triggers>
					</ControlTemplate>
				</Setter.Value>
			</Setter>
		</Style>

		<Style x:Key="ColorSwatch" TargetType="Button">
			<Setter Property="Width" Value="32"/>
			<Setter Property="Height" Value="32"/>
			<Setter Property="Margin" Value="4"/>
			<Setter Property="Cursor" Value="Hand"/>
			<Setter Property="Template">
				<Setter.Value>
					<ControlTemplate TargetType="Button">
						<Grid>
							<Ellipse x:Name="Border" Stroke="Transparent" StrokeThickness="2" Width="32" Height="32"/>
							<Ellipse x:Name="ColorCircle" Width="24" Height="24" Fill="{TemplateBinding Background}"/>
						</Grid>
						<ControlTemplate.Triggers>
							<Trigger Property="IsMouseOver" Value="True">
								<Setter TargetName="Border" Property="Stroke" Value="#66FFFFFF"/>
							</Trigger>
						</ControlTemplate.Triggers>
					</ControlTemplate>
				</Setter.Value>
			</Setter>
		</Style>
	</Window.Resources>

	<!-- 主体背景色 #202020 -->
	<Border Background="#202020" CornerRadius="8" BorderBrush="#1A1A1A" BorderThickness="1">
		<Grid>
			<Grid.RowDefinitions>
				<RowDefinition Height="Auto"/>
				<!-- Header -->
				<RowDefinition Height="Auto"/>
				<!-- Main Picker Area -->
				<RowDefinition Height="*"/>
				<!-- Swatches -->
				<RowDefinition Height="Auto"/>
				<!-- Footer -->
			</Grid.RowDefinitions>

			<!-- 1. Header (标题栏) -->
			<!-- 使用独立背景色 #2C2C2C，并只在上方设置圆角 -->
			<Border Grid.Row="0" Background="#2C2C2C" CornerRadius="8,8,0,0"
                    MouseLeftButtonDown="TitleBar_MouseDown" Margin="0,0,0,20">
				<Grid Margin="24,10,24,10">
					<TextBlock Text="编辑颜色" FontSize="16" FontWeight="SemiBold" Foreground="#DDD" VerticalAlignment="Center"/>
					<Button HorizontalAlignment="Right" Content="✕" Width="32" Height="32"
                            Style="{StaticResource FluentButton}" Background="Transparent" Foreground="#BBB"
                            Click="CancelButton_Click"/>
				</Grid>
			</Border>

			<!-- 2. Main Picker Area -->
			<Grid Grid.Row="1" Height="280" Margin="24,0">
				<Grid.ColumnDefinitions>
					<ColumnDefinition Width="280"/>
					<!-- Square -->
					<ColumnDefinition Width="50"/>
					<!-- Slider -->
					<ColumnDefinition Width="*"/>
					<!-- Inputs -->
				</Grid.ColumnDefinitions>

				<!-- Color Map (Sat/Val) -->
				<!-- 将事件绑定在 Grid 上，保证最优先触发 -->
				<Grid Grid.Column="0" ClipToBounds="False" Cursor="Cross"
                      MouseLeftButtonDown="Spectrum_MouseDown"
                      MouseMove="Spectrum_MouseMove"
                      MouseLeftButtonUp="Spectrum_MouseUp">

					<Rectangle x:Name="SpectrumBaseColor" Fill="Red" RadiusX="4" RadiusY="4"/>
					<Rectangle RadiusX="4" RadiusY="4">
						<Rectangle.Fill>
							<LinearGradientBrush StartPoint="0,0" EndPoint="1,0">
								<GradientStop Color="White" Offset="0"/>
								<GradientStop Color="#00FFFFFF" Offset="1"/>
							</LinearGradientBrush>
						</Rectangle.Fill>
					</Rectangle>
					<Rectangle RadiusX="4" RadiusY="4">
						<Rectangle.Fill>
							<LinearGradientBrush StartPoint="0,1" EndPoint="0,0">
								<GradientStop Color="Black" Offset="0"/>
								<GradientStop Color="#00000000" Offset="1"/>
							</LinearGradientBrush>
						</Rectangle.Fill>
					</Rectangle>

					<Canvas x:Name="CursorCanvas" IsHitTestVisible="False">
						<Ellipse x:Name="ColorCursor" Width="16" Height="16" Stroke="White" StrokeThickness="2" Margin="-8,-8,0,0">
							<Ellipse.Effect>
								<DropShadowEffect BlurRadius="4" ShadowDepth="0" Color="Black"/>
							</Ellipse.Effect>
						</Ellipse>
					</Canvas>
				</Grid>

				<!-- Hue Slider -->
				<Grid Grid.Column="1" Margin="10,0"
      Background="Transparent"
      MouseLeftButtonDown="Hue_MouseDown"
      MouseMove="Hue_MouseMove"
      MouseLeftButtonUp="Hue_MouseUp"
      Cursor="Hand"
      x:Name="HueSliderGrid">
					<!-- 增加 x:Name 方便后台调用 -->

					<!-- 彩色条：水平居中 -->
					<Border CornerRadius="15" ClipToBounds="True" Width="14" HorizontalAlignment="Center" IsHitTestVisible="False">
						<Image x:Name="HueSliderImage" Stretch="Fill" />
					</Border>

					<!-- Slider Thumb -->
					<!-- Canvas 填满 Grid -->
					<Canvas x:Name="HueCursorCanvas" IsHitTestVisible="False" HorizontalAlignment="Stretch" VerticalAlignment="Stretch">
						<!-- 修复2: 移除 TranslateTransform，通过代码控制 Left/Top 或简单居中 -->
						<Grid x:Name="HueCursor" Width="14" Height="14" Margin="0,-7,0,0">
							<Ellipse Width="14" Height="14" Fill="White" Stroke="#333" StrokeThickness="1">
								<Ellipse.Effect>
									<DropShadowEffect BlurRadius="4" ShadowDepth="1" Opacity="0.5"/>
								</Ellipse.Effect>
							</Ellipse>
						</Grid>
					</Canvas>
				</Grid>
				<!-- Inputs & Preview -->
				<StackPanel Grid.Column="2" Margin="10,0,0,0">
					<!-- Preview Box -->
					<Grid Height="60" Margin="0,0,0,20">
						<Grid.ColumnDefinitions>
							<ColumnDefinition Width="*"/>
							<ColumnDefinition Width="*"/>
						</Grid.ColumnDefinitions>
						<Border Background="{Binding Fill, ElementName=OriginalColorRect}" CornerRadius="4,0,0,4" BorderBrush="#444" BorderThickness="1"/>
						<Rectangle x:Name="OriginalColorRect" Fill="Gray" Visibility="Hidden"/>

						<Border Grid.Column="1" Background="{Binding Fill, ElementName=NewColorRect}" CornerRadius="0,4,4,0" BorderBrush="#444" BorderThickness="1"/>
						<Rectangle x:Name="NewColorRect" Fill="Red" Visibility="Hidden"/>

						<TextBlock Text="预览" Foreground="White" VerticalAlignment="Center" HorizontalAlignment="Center" Grid.ColumnSpan="2" IsHitTestVisible="False" Opacity="0.8" FontSize="12">
							<TextBlock.Effect>
								<DropShadowEffect ShadowDepth="0" BlurRadius="2" Color="Black"/>
							</TextBlock.Effect>
						</TextBlock>
					</Grid>

					<!-- Hex Input -->
					<Grid Margin="0,0,0,15">
						<Grid.ColumnDefinitions>
							<ColumnDefinition Width="*"/>
							<ColumnDefinition Width="Auto"/>
						</Grid.ColumnDefinitions>
						<TextBox x:Name="HexInput" Style="{StaticResource FluentTextBox}" Text="#FF0000" TextChanged="HexInput_TextChanged"/>
						<TextBlock Text="HEX" Grid.Column="1" VerticalAlignment="Center" Margin="10,0,0,0" Foreground="#AAA"/>
					</Grid>

					<Separator Background="#333" Margin="0,5,0,15"/>

					<!-- RGB Inputs -->
					<Grid Margin="0,0,0,8">
						<Grid.ColumnDefinitions>
							<ColumnDefinition Width="*"/>
							<ColumnDefinition Width="Auto"/>
						</Grid.ColumnDefinitions>
						<TextBox x:Name="RInput" Style="{StaticResource FluentTextBox}" Text="255" TextChanged="RGBInput_TextChanged"/>
						<TextBlock Text="红 (R)" Grid.Column="1" VerticalAlignment="Center" Margin="10,0,0,0" Foreground="#AAA"/>
					</Grid>

					<Grid Margin="0,0,0,8">
						<Grid.ColumnDefinitions>
							<ColumnDefinition Width="*"/>
							<ColumnDefinition Width="Auto"/>
						</Grid.ColumnDefinitions>
						<TextBox x:Name="GInput" Style="{StaticResource FluentTextBox}" Text="0" TextChanged="RGBInput_TextChanged"/>
						<TextBlock Text="绿 (G)" Grid.Column="1" VerticalAlignment="Center" Margin="10,0,0,0" Foreground="#AAA"/>
					</Grid>

					<Grid>
						<Grid.ColumnDefinitions>
							<ColumnDefinition Width="*"/>
							<ColumnDefinition Width="Auto"/>
						</Grid.ColumnDefinitions>
						<TextBox x:Name="BInput" Style="{StaticResource FluentTextBox}" Text="0" TextChanged="RGBInput_TextChanged"/>
						<TextBlock Text="蓝 (B)" Grid.Column="1" VerticalAlignment="Center" Margin="10,0,0,0" Foreground="#AAA"/>
					</Grid>
				</StackPanel>
			</Grid>

			<!-- 3. Color Swatches -->
			<Grid Grid.Row="2" Margin="24,20,24,0">
				<Grid.ColumnDefinitions>
					<ColumnDefinition Width="*"/>
					<ColumnDefinition Width="Auto"/>
				</Grid.ColumnDefinitions>

				<!-- Basic Colors -->
				<StackPanel>
					<TextBlock Text="基本颜色" Foreground="#BBB" FontSize="12" Margin="4,0,0,8"/>
					<UniformGrid Columns="9" HorizontalAlignment="Left" x:Name="BasicColorsGrid">
						<Button Style="{StaticResource ColorSwatch}" Background="#FFB900" Click="Swatch_Click"/>
						<Button Style="{StaticResource ColorSwatch}" Background="#FF8C00" Click="Swatch_Click"/>
						<Button Style="{StaticResource ColorSwatch}" Background="#F7630C" Click="Swatch_Click"/>
						<Button Style="{StaticResource ColorSwatch}" Background="#CA5010" Click="Swatch_Click"/>
						<Button Style="{StaticResource ColorSwatch}" Background="#DA3B01" Click="Swatch_Click"/>
						<Button Style="{StaticResource ColorSwatch}" Background="#EF6950" Click="Swatch_Click"/>
						<Button Style="{StaticResource ColorSwatch}" Background="#D13438" Click="Swatch_Click"/>
						<Button Style="{StaticResource ColorSwatch}" Background="#FF4343" Click="Swatch_Click"/>
						<Button Style="{StaticResource ColorSwatch}" Background="#E74856" Click="Swatch_Click"/>

						<Button Style="{StaticResource ColorSwatch}" Background="#E81123" Click="Swatch_Click"/>
						<Button Style="{StaticResource ColorSwatch}" Background="#EA005E" Click="Swatch_Click"/>
						<Button Style="{StaticResource ColorSwatch}" Background="#C30052" Click="Swatch_Click"/>
						<Button Style="{StaticResource ColorSwatch}" Background="#E3008C" Click="Swatch_Click"/>
						<Button Style="{StaticResource ColorSwatch}" Background="#BF0077" Click="Swatch_Click"/>
						<Button Style="{StaticResource ColorSwatch}" Background="#C239B3" Click="Swatch_Click"/>
						<Button Style="{StaticResource ColorSwatch}" Background="#9A0089" Click="Swatch_Click"/>
						<Button Style="{StaticResource ColorSwatch}" Background="#0078D7" Click="Swatch_Click"/>
						<Button Style="{StaticResource ColorSwatch}" Background="#0063B1" Click="Swatch_Click"/>
					</UniformGrid>
				</StackPanel>

				<!-- Custom Colors -->
				<StackPanel Grid.Column="1" Margin="20,0,0,0">
					<StackPanel Orientation="Horizontal" Margin="4,0,0,8">
						<TextBlock Text="自定义颜色" Foreground="#BBB" FontSize="12" VerticalAlignment="Center"/>
						<Button Content="+" Width="24" Height="24" Margin="10,0,0,0" Padding="0" Background="#333" Foreground="White" BorderThickness="0">
							<Button.Template>
								<ControlTemplate TargetType="Button">
									<Border Background="{TemplateBinding Background}" CornerRadius="12">
										<TextBlock Text="+" HorizontalAlignment="Center" VerticalAlignment="Center" Margin="0,-2,0,0"/>
									</Border>
								</ControlTemplate>
							</Button.Template>
						</Button>
					</StackPanel>

					<UniformGrid Columns="4" x:Name="CustomColorsGrid">
						<Border Width="32" Height="32" Margin="4" CornerRadius="16" BorderBrush="#444" BorderThickness="1" Background="Transparent"/>
						<Border Width="32" Height="32" Margin="4" CornerRadius="16" BorderBrush="#444" BorderThickness="1" Background="Transparent"/>
						<Border Width="32" Height="32" Margin="4" CornerRadius="16" BorderBrush="#444" BorderThickness="1" Background="Transparent"/>
						<Border Width="32" Height="32" Margin="4" CornerRadius="16" BorderBrush="#444" BorderThickness="1" Background="Transparent"/>

						<Border Width="32" Height="32" Margin="4" CornerRadius="16" BorderBrush="#444" BorderThickness="1" Background="Transparent"/>
						<Border Width="32" Height="32" Margin="4" CornerRadius="16" BorderBrush="#444" BorderThickness="1" Background="Transparent"/>
						<Border Width="32" Height="32" Margin="4" CornerRadius="16" BorderBrush="#444" BorderThickness="1" Background="Transparent"/>
						<Border Width="32" Height="32" Margin="4" CornerRadius="16" BorderBrush="#444" BorderThickness="1" Background="Transparent"/>
					</UniformGrid>
				</StackPanel>
			</Grid>

			<!-- 4. Footer -->
			<Grid Grid.Row="3" Margin="24,20,24,24">
				<StackPanel Orientation="Horizontal" HorizontalAlignment="Right">
					<Button Content="确定" Width="120" Height="36" Style="{StaticResource FluentAccentButton}" Click="OkButton_Click" Margin="0,0,10,0"/>
					<Button Content="取消" Width="120" Height="36" Style="{StaticResource FluentButton}" Click="CancelButton_Click"/>
				</StackPanel>
			</Grid>
		</Grid>
	</Border>
</Window>

<Window x:Class="TabPaint.WatermarkWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:local="clr-namespace:TabPaint"
        mc:Ignorable="d"
        Title="{DynamicResource L_Watermark_Title}" Height="700" Width="850"
        MinWidth="500" MinHeight="500"
        WindowStartupLocation="CenterOwner" WindowStyle="None"
        ResizeMode="CanResize"
        Background="Transparent"
        FontFamily="Microsoft YaHei UI, Segoe UI, sans-serif"
        TextOptions.TextFormattingMode="Ideal"
        TextOptions.TextRenderingMode="ClearType">

    <WindowChrome.WindowChrome>
        <WindowChrome CaptionHeight="0" GlassFrameThickness="-1" ResizeBorderThickness="6" CornerRadius="0" />
    </WindowChrome.WindowChrome>

    <Window.Resources>
        <ResourceDictionary>
            <ResourceDictionary.MergedDictionaries>
                <ResourceDictionary Source="pack://application:,,,/Resources/SubWindowStyles.xaml"/>
            </ResourceDictionary.MergedDictionaries>

            <!-- 简单的面板淡入淡出动画 -->
            <Storyboard x:Key="FadeInAnimation">
                <DoubleAnimation Storyboard.TargetProperty="Opacity" From="0" To="1" Duration="0:0:0.15"/>
                <DoubleAnimation Storyboard.TargetProperty="(UIElement.RenderTransform).(TranslateTransform.Y)" From="10" To="0" Duration="0:0:0.15">
                    <DoubleAnimation.EasingFunction>
                        <CubicEase EasingMode="EaseOut"/>
                    </DoubleAnimation.EasingFunction>
                </DoubleAnimation>
            </Storyboard>
        </ResourceDictionary>
    </Window.Resources>

    <Border Background="Transparent" BorderBrush="{DynamicResource BorderMediumBrush}" BorderThickness="1">
        <Grid>
            <Grid.RowDefinitions>
                <RowDefinition Height="32"/>
                <RowDefinition Height="*"/>
                <RowDefinition Height="Auto"/>
            </Grid.RowDefinitions>

            <!-- 1. 标题栏 -->
            <Border Background="Transparent" 
         CornerRadius="12" 
         BorderBrush="{DynamicResource BorderLightBrush}" 
         BorderThickness="1" MouseLeftButtonDown="TitleBar_MouseLeftButtonDown">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="32"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>

                    <Border Grid.Row="0" BorderThickness="0,0,0,1" Background="Transparent">
                        <Grid >
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>

                            <Image Grid.Column="0" Source="pack://application:,,,/Resources/TabPaint.ico" 
                        Width="20" Height="20" Margin="12,0,8,0" 
                        RenderOptions.BitmapScalingMode="HighQuality"/>

                            <TextBlock Grid.Column="1" Text="{DynamicResource L_Watermark_Title}" 
                            VerticalAlignment="Center" Foreground="{DynamicResource TextSecondaryBrush}" FontSize="12"/>

                            <StackPanel Grid.Column="2" Orientation="Horizontal" VerticalAlignment="Top">

                                <Button Width="48" Height="30" ToolTip="{DynamicResource L_TitleBar_Close}" Click="OnCloseClick" Style="{StaticResource WindowCloseButtonStyle}">
                                    <Viewbox Width="10" Height="10">
                                        <Path Stroke="{Binding RelativeSource={RelativeSource AncestorType=Button}, Path=Foreground}" 
                           StrokeThickness="1" 
                           Data="M0,0 L12,12 M12,0 L0,12"/>
                                    </Viewbox>
                                </Button>
                            </StackPanel>
                        </Grid>
                    </Border>
                </Grid>
            </Border>

            <!-- 2. 内容区域 -->
            <Grid Grid.Row="1">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="320"/>
                    <ColumnDefinition Width="*"/>
                </Grid.ColumnDefinitions>

                <!-- 左侧：设置面板 -->
                <ScrollViewer Style="{StaticResource FluentScrollViewer}" Background="{DynamicResource GlassBackgroundMediumBrush}" Grid.Column="0" VerticalScrollBarVisibility="Auto" BorderBrush="{DynamicResource BorderLightBrush}" BorderThickness="0,0,1,0">
                    <StackPanel Margin="16,12">

                        <!-- 模式选择卡片 -->
                        <Border Style="{StaticResource SubWindowCardStyle}">
                            <StackPanel>
                                <StackPanel Orientation="Horizontal" Margin="0,0,0,10">
                                    <Path Data="M12,2L4.5,20.29L5.21,21L12,18L18.79,21L19.5,20.29L12,2Z" Style="{StaticResource IconPathStyle}"/>
                                    <TextBlock  Foreground="{DynamicResource TextSecondaryBrush}" Text="{DynamicResource L_Watermark_Type}" FontWeight="SemiBold" VerticalAlignment="Center"/>
                                </StackPanel>
                                <StackPanel Orientation="Horizontal">
                                    <RadioButton Content="{DynamicResource L_Watermark_TypeText}" IsChecked="True" x:Name="RadioText" GroupName="WMType" Checked="Mode_Checked" Margin="0,0,20,0" Style="{StaticResource ThemeRadioButtonStyle}"/>
                                    <RadioButton Content="{DynamicResource L_Watermark_TypeImage}" x:Name="RadioImage" GroupName="WMType" Checked="Mode_Checked" Style="{StaticResource ThemeRadioButtonStyle}"/>
                                </StackPanel>
                            </StackPanel>
                        </Border>

                        <!-- 文本设置卡片 -->
                        <Border x:Name="PanelText" Style="{StaticResource SubWindowCardStyle}" Visibility="Visible" Opacity="1">
                            <Border.RenderTransform>
                                <TranslateTransform Y="0"/>
                            </Border.RenderTransform>
                            <StackPanel>
                                <StackPanel Orientation="Horizontal" Margin="0,0,0,12">
                                    <Path Data="M2.5,4v3h5v12h3V7h5V4H2.5z M21.5,9h-9v3h3v7h3v-7h3V9z" Style="{StaticResource IconPathStyle}"/>
                                    <TextBlock  Foreground="{DynamicResource TextSecondaryBrush}" Text="{DynamicResource L_Watermark_Content}" FontWeight="SemiBold" VerticalAlignment="Center"/>
                                </StackPanel>

                                <TextBox x:Name="TxtContent" Text="TabPaint" Height="32" Padding="8,4" TextChanged="Input_TextChanged" Margin="0,0,0,12" Style="{StaticResource ModernTextBoxStyle}" Tag="水印文字"/>

                                <Grid Margin="0,0,0,8">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="12"/>
                                        <ColumnDefinition Width="*"/>
                                    </Grid.ColumnDefinitions>
                                    <StackPanel Grid.Column="0">
                                        <TextBlock Text="{DynamicResource L_Watermark_FontSize}" Style="{StaticResource LabelStyle}" Margin="0,0,0,4" FontSize="11" Opacity="0.7"/>
                                        <TextBox x:Name="TxtFontSize" Text="40" Height="32" PreviewTextInput="NumberValidationTextBox" TextChanged="Input_TextChanged" Style="{StaticResource ModernTextBoxStyle}"/>
                                    </StackPanel>
                                    <StackPanel Grid.Column="2">
                                        <TextBlock Text="{DynamicResource L_Common_Font}" Style="{StaticResource LabelStyle}" Margin="0,0,0,4" FontSize="11" Opacity="0.7"/>
                                        <ComboBox x:Name="ComboFontFamily" 
          Height="32" 
          SelectionChanged="Param_Changed_Combo" 
          Style="{StaticResource FluentComboBoxStyle}">
                                            <ComboBox.ItemTemplate>
                                                <DataTemplate>
                                                    <TextBlock Text="{Binding DisplayName}" 
                       FontFamily="{Binding FontFamily}" 
                       FontSize="14" 
                       VerticalAlignment="Center"/>
                                                </DataTemplate>
                                            </ComboBox.ItemTemplate>
                                        </ComboBox>
                                    </StackPanel>
                                </Grid>

                                <TextBlock Text="{DynamicResource L_Watermark_Color}" Style="{StaticResource LabelStyle}" Margin="0,8,0,4" FontSize="11" Opacity="0.7"/>
                                <Grid>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="8"/>
                                        <ColumnDefinition Width="Auto"/>
                                    </Grid.ColumnDefinitions>
                                    <ComboBox Grid.Column="0" x:Name="ComboCommonColors" Height="32" SelectionChanged="CommonColor_SelectionChanged" Style="{StaticResource FluentComboBoxStyle}" Margin="0"/>
                                    <Border Grid.Column="2" Width="32" Height="32" BorderBrush="{DynamicResource BorderBrush}" BorderThickness="1" CornerRadius="4" Cursor="Hand" MouseLeftButtonDown="ColorPreview_Click">
                                        <Border.Background>
                                            <VisualBrush TileMode="Tile" Viewport="0,0,8,8" ViewportUnits="Absolute">
                                                <VisualBrush.Visual>
                                                    <Grid Background="#FFF">
                                                        <Path Data="M0,0 L4,0 L4,4 L0,4 Z M4,4 L8,4 L8,8 L4,8 Z" Fill="#CCC" />
                                                    </Grid>
                                                </VisualBrush.Visual>
                                            </VisualBrush>
                                        </Border.Background>
                                        <Rectangle x:Name="RectColorPreview" Fill="White" RadiusX="3" RadiusY="3"/>
                                    </Border>
                                </Grid>
                                <TextBox x:Name="TxtHexColor" Text="#FFFFFF" MaxLength="7" Height="28" Margin="0,8,0,0" TextChanged="HexInput_TextChanged" Style="{StaticResource ModernTextBoxStyle}" HorizontalContentAlignment="Center" FontFamily="Consolas" FontSize="12"/>
                            </StackPanel>
                        </Border>

                        <!-- 图片设置卡片 -->
                        <Border x:Name="PanelImage" Style="{StaticResource SubWindowCardStyle}" Visibility="Collapsed">
                            <Border.RenderTransform>
                                <TranslateTransform Y="0"/>
                            </Border.RenderTransform>
                            <StackPanel>
                                <StackPanel Orientation="Horizontal" Margin="0,0,0,12">
                                    <Path Data="M21,19V5C21,3.9 20.1,3 19,3H5C3.9,3 3,3.9 3,5V19C3,20.1 3.9,21 5,21H19C20.1,21 21,20.1 21,19M8.5,13.5L11,16.51L14.5,12L19,18H5L8.5,13.5Z" Style="{StaticResource IconPathStyle}"/>
                                    <TextBlock Text="{DynamicResource L_Watermark_TypeImage}" FontWeight="SemiBold" VerticalAlignment="Center"/>
                                </StackPanel>

                                <Border Height="100" Margin="0,0,0,12" BorderBrush="{DynamicResource BorderBrush}" BorderThickness="1,1,1,1" CornerRadius="6" Background="{DynamicResource ChromeLowBrush}" AllowDrop="True" Drop="Image_Drop" MouseLeftButtonDown="ImageSelect_Click" Cursor="Hand">
                                    <Grid>
                                        <StackPanel VerticalAlignment="Center" HorizontalAlignment="Center">
                                            <Path Data="M19.35,10.04C18.67,6.59 15.64,4 12,4C9.11,4 6.6,5.64 5.35,8.04C2.34,8.36 0,10.91 0,14C0,17.31 2.69,20 6,20H19C21.76,20 24,17.76 24,15C24,12.36 21.95,10.22 19.35,10.04M14,13V17H10V13H7L12,8L17,13H14Z" 
                                                  Fill="{DynamicResource TextTertiaryBrush}" Width="32" Height="32" Stretch="Uniform" Margin="0,0,0,8"/>
                                            <TextBlock x:Name="TxtImageName" Text="{DynamicResource L_Watermark_ClickOrDrop}" Foreground="{DynamicResource TextTertiaryBrush}" HorizontalAlignment="Center" FontSize="11"/>
                                        </StackPanel>
                                        <Image x:Name="ImgPreview" Stretch="Uniform" Opacity="0.4" Margin="4"/>
                                    </Grid>
                                </Border>

                                <TextBlock Text="{DynamicResource L_Watermark_ImageScale}" Style="{StaticResource LabelStyle}" Margin="0,0,0,4" FontSize="11" Opacity="0.7"/>
                                <Grid>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="40"/>
                                    </Grid.ColumnDefinitions>
                                    <Slider x:Name="SliderImgScale" Minimum="0.1" Maximum="2.0" Value="0.8" ValueChanged="Param_ValueChanged" VerticalAlignment="Center"/>
                                    <TextBlock Grid.Column="1" Text="{Binding Value, ElementName=SliderImgScale, StringFormat=P0}" VerticalAlignment="Center" HorizontalAlignment="Right" FontSize="11" Opacity="0.8"/>
                                </Grid>
                            </StackPanel>
                        </Border>

                        <!-- 通用排版卡片 -->
                        <Border Style="{StaticResource SubWindowCardStyle}">
                            <StackPanel>
                                <StackPanel Orientation="Horizontal" Margin="0,0,0,12">
                                    <Path Data="M4,10.5c-.83,0-1.5,.67-1.5,1.5s.67,1.5,1.5,1.5,1.5-.67,1.5-1.5-.67-1.5-1.5-1.5zm0-6c-.83,0-1.5,.67-1.5,1.5s.67,1.5,1.5,1.5,1.5-.67,1.5-1.5-.67-1.5-1.5-1.5zm0,12c-.83,0-1.5,.67-1.5,1.5s.67,1.5,1.5,1.5,1.5-.67,1.5-1.5-.67-1.5-1.5-1.5zm4-12h14v3H8V4.5zm0,12h14v3H8v-3zm0-6h14v3H8v-3z" Style="{StaticResource IconPathStyle}"/>
                                    <TextBlock  Foreground="{DynamicResource TextSecondaryBrush}" Text="{DynamicResource L_Menu_QA_Settings}" FontWeight="SemiBold" VerticalAlignment="Center"/>
                                </StackPanel>

                                <Grid Margin="0,0,0,4">
                                    <TextBlock Text="{DynamicResource L_Watermark_Opacity}" Style="{StaticResource LabelStyle}" FontSize="11" Opacity="0.7"/>
                                    <TextBlock Foreground="{DynamicResource TextSecondaryBrush}" Text="{Binding Value, ElementName=SliderOpacity, StringFormat=P0}" HorizontalAlignment="Right" FontSize="11" Opacity="0.8"/>
                                </Grid>
                                <Slider x:Name="SliderOpacity" Minimum="0" Maximum="1" Value="0.5" ValueChanged="Param_ValueChanged" Margin="0,0,0,12"/>

                                <Grid Margin="0,0,0,4">
                                    <TextBlock Text="{DynamicResource L_Watermark_Angle}" Style="{StaticResource LabelStyle}" FontSize="11" Opacity="0.7"/>
                                    <TextBlock Foreground="{DynamicResource TextSecondaryBrush}" Text="{Binding Value, ElementName=SliderAngle, StringFormat=N0}" HorizontalAlignment="Right" FontSize="11" Opacity="0.8"/>
                                </Grid>
                                <Slider x:Name="SliderAngle" Minimum="-180" Maximum="180" Value="-45" ValueChanged="Param_ValueChanged" Margin="0,0,0,12"/>

                                <Grid>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="12"/>
                                        <ColumnDefinition Width="*"/>
                                    </Grid.ColumnDefinitions>
                                    <StackPanel Grid.Column="0">
                                        <Grid Margin="0,0,0,4">
                                            <TextBlock Text="{DynamicResource L_Watermark_Rows}" Style="{StaticResource LabelStyle}" Margin="0,0,0,4" FontSize="11" Opacity="0.7"/>
                                            <TextBlock Foreground="{DynamicResource TextSecondaryBrush}" Text="{Binding Value, ElementName=SliderRows, StringFormat=N0}" HorizontalAlignment="Right" FontSize="11" Opacity="0.8"/>
                                        </Grid>
                                        <Slider x:Name="SliderRows" Minimum="1" Maximum="20" Value="3" ValueChanged="Param_ValueChanged"/>
                                    </StackPanel>
                                    <StackPanel Grid.Column="2">
                                        <Grid Margin="0,0,0,4">
                                            <TextBlock Text="{DynamicResource L_Watermark_Cols}" Style="{StaticResource LabelStyle}" Margin="0,0,0,4" FontSize="11" Opacity="0.7"/>
                                            <TextBlock Foreground="{DynamicResource TextSecondaryBrush}" Text="{Binding Value, ElementName=SliderCols, StringFormat=N0}" HorizontalAlignment="Right" FontSize="11" Opacity="0.8"/>
                                        </Grid>
                                        <Slider x:Name="SliderCols" Minimum="1" Maximum="20" Value="3" ValueChanged="Param_ValueChanged"/>
                                    </StackPanel>
                                </Grid>

                                <StackPanel Orientation="Horizontal" Margin="0,12,0,0">
                                    <CheckBox Foreground="{DynamicResource TextSecondaryBrush}" FontSize="12" x:Name="ChkRandom" Content="{DynamicResource L_Watermark_RandomOffset}" Style="{StaticResource FluentCheckBoxStyle}" Checked="Generic_Changed" Unchecked="Generic_Changed" Margin="0,0,12,0"/>
                                    <CheckBox Foreground="{DynamicResource TextSecondaryBrush}" FontSize="12" x:Name="ChkApplyToAll" Content="{DynamicResource L_Watermark_ApplyToAll}" Style="{StaticResource FluentCheckBoxStyle}"/>
                                </StackPanel>
                            </StackPanel>
                        </Border>
                    </StackPanel>
                </ScrollViewer>

                <!-- 右侧：预览区域 -->
                <Grid Grid.Column="1" Background="{DynamicResource GlassBackgroundMediumBrush}">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                    </Grid.RowDefinitions>

                    <StackPanel Grid.Row="0" Orientation="Horizontal" Margin="20,15">
                        <Path Data="M12,9c-1.66,0-3,1.34-3,3s1.34,3,3,3,3-1.34,3-3-1.34-3-3-3zM12,17c-2.76,0-5-2.24-5-5s2.24-5,5-5,5,2.24,5,5-2.24,5-5,5zM12,4.5C7,4.5 2.73,7.61 1,12c1.73,4.39 6,7.5 11,7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12,17c-2.76,0-5-2.24-5-5s2.24-5,5-5,5,2.24,5,5-2.24,5-5,5z" 
                              Style="{StaticResource IconPathStyle}" Width="18" Height="18"/>
                        <TextBlock Text="{DynamicResource L_Common_Preview}" Foreground="{DynamicResource TextSecondaryBrush}" FontWeight="SemiBold" FontSize="14" VerticalAlignment="Center"/>
                    </StackPanel>

                    <Border Grid.Row="1" Margin="20,0,20,20" BorderBrush="{DynamicResource BorderBrush}" BorderThickness="1" CornerRadius="8" Background="{StaticResource CheckerboardBrush}" ClipToBounds="True">
                        <Grid>
                            <!-- 分层预览：底图层 -->
                            <Image x:Name="ImgWindowBackground" Stretch="Uniform" RenderOptions.BitmapScalingMode="HighQuality"/>
                            <!-- 分层预览：水印层 (实时矢量预览，移除昂贵的 DropShadowEffect 以确保流畅) -->
                            <Image x:Name="ImgWindowPreview" Stretch="Uniform" RenderOptions.BitmapScalingMode="HighQuality"/>
                        </Grid>
                    </Border>
                </Grid>
            </Grid>

            <!-- 3. 底部按钮 -->
            <Border Grid.Row="2" Background="{DynamicResource GlassBackgroundLowBrush}" Padding="20,10" BorderThickness="0,1,0,0" BorderBrush="{DynamicResource BorderLightBrush}">
                <Grid>
                    <Button Height="32" Content="{DynamicResource L_Common_Reset}" Width="100" HorizontalAlignment="Left" Click="Reset_Click" Style="{StaticResource Win11SecondaryButtonStyle}"/>
                    <StackPanel Orientation="Horizontal" HorizontalAlignment="Right">
                        <Button Content="{DynamicResource L_Common_OK}" Width="110" Margin="0,0,12,0" Click="Ok_Click" Style="{StaticResource AccentButtonStyle}" IsDefault="True"/>
                        <Button Content="{DynamicResource L_Common_Cancel}" Width="110" Click="Cancel_Click" IsCancel="True" Style="{StaticResource Win11SecondaryButtonStyle}"/>
                    </StackPanel>
                </Grid>
            </Border>
        </Grid>
    </Border>
</Window>

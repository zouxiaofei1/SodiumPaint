<UserControl x:Class="TabPaint.Pages.AdvancedPage"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
             xmlns:local="clr-namespace:TabPaint"
             mc:Ignorable="d" 
             d:DesignHeight="600" d:DesignWidth="500"
             Background="Transparent">

    <UserControl.Resources>
        <ResourceDictionary>
            <ResourceDictionary.MergedDictionaries>
                <ResourceDictionary Source="pack://application:,,,/Resources/SubWindowStyles.xaml"/>
            </ResourceDictionary.MergedDictionaries>
            <local:NonLinearConverter x:Key="NonLinearConverter"/>

            <!-- 组合输入框样式：左侧文本框 -->
            <Style x:Key="LeftPartTextBoxStyle" TargetType="TextBox" BasedOn="{StaticResource {x:Type TextBox}}">
                <Setter Property="Height" Value="30"/>
                <Setter Property="Template">
                    <Setter.Value>
                        <ControlTemplate TargetType="{x:Type TextBox}">
                            <Border x:Name="border"
                                    Background="{TemplateBinding Background}"
                                    BorderBrush="{TemplateBinding BorderBrush}"
                                    BorderThickness="1,1,0,1"
                                    CornerRadius="4,0,0,4" 
                                    SnapsToDevicePixels="True">
                                <Grid>
                                    <ScrollViewer x:Name="PART_ContentHost" Focusable="false" HorizontalScrollBarVisibility="Hidden" VerticalScrollBarVisibility="Hidden"/>
                                </Grid>
                            </Border>
                            <ControlTemplate.Triggers>
                                <Trigger Property="IsMouseOver" Value="true">
                                    <Setter TargetName="border" Property="BorderBrush" Value="{DynamicResource BorderFocusBrush}"/>
                                </Trigger>
                                <Trigger Property="IsKeyboardFocused" Value="true">
                                    <Setter TargetName="border" Property="BorderBrush" Value="{DynamicResource SystemAccentBrush}"/>
                                </Trigger>
                            </ControlTemplate.Triggers>
                        </ControlTemplate>
                    </Setter.Value>
                </Setter>
            </Style>

            <!-- 组合输入框样式：右侧按钮 -->
            <Style x:Key="RightPartButtonStyle" TargetType="Button">
                <Setter Property="Background" Value="{DynamicResource ButtonBackgroundBrush}"/>
                <Setter Property="BorderBrush" Value="{DynamicResource BorderBrush}"/>
                <Setter Property="Foreground" Value="{DynamicResource TextPrimaryBrush}"/>
                <Setter Property="BorderThickness" Value="1"/>
                <Setter Property="Padding" Value="0"/>
                <Setter Property="FontSize" Value="12"/>
                <Setter Property="Template">
                    <Setter.Value>
                        <ControlTemplate TargetType="Button">
                            <Border x:Name="border" Background="{TemplateBinding Background}" 
                                    BorderBrush="{TemplateBinding BorderBrush}" 
                                    BorderThickness="1" 
                                    CornerRadius="0,4,4,0">
                                <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                            </Border>
                            <ControlTemplate.Triggers>
                                <Trigger Property="IsMouseOver" Value="True">
                                    <Setter TargetName="border" Property="Background" Value="{DynamicResource ButtonHoverBrush}"/>
                                </Trigger>
                                <Trigger Property="IsPressed" Value="True">
                                    <Setter TargetName="border" Property="Background" Value="{DynamicResource ButtonPressedBrush}"/>
                                </Trigger>
                            </ControlTemplate.Triggers>
                        </ControlTemplate>
                    </Setter.Value>
                </Setter>
            </Style>
        </ResourceDictionary>
    </UserControl.Resources>

    <StackPanel Margin="24,24,44,24">
        <TextBlock Text="{DynamicResource L_Settings_Advanced_Title}" FontSize="20" FontWeight="SemiBold" Margin="0,0,0,20" Foreground="{DynamicResource TextPrimaryBrush}"/>

        <!-- 渲染设置 -->
        <TextBlock Text="{DynamicResource L_Settings_Advanced_Render_Header}" FontWeight="SemiBold" FontSize="16" Margin="0,5,0,10" Foreground="{DynamicResource TextPrimaryBrush}"/>

        <!-- 采样模式 -->
        <Grid Margin="0,5">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="220"/>
                <ColumnDefinition Width="200"/>
            </Grid.ColumnDefinitions>
            <StackPanel VerticalAlignment="Center">
                <TextBlock Text="{DynamicResource L_Settings_Advanced_Resampling_Title}"/>
                <TextBlock Text="{DynamicResource L_Settings_Advanced_Resampling_Desc}" Foreground="{DynamicResource TextTertiaryBrush}" FontSize="11" Margin="0,2,0,0"/>
            </StackPanel>

            <ComboBox Grid.Column="1" 
                      Style="{StaticResource FluentComboBoxStyle}"
                      SelectedValue="{Binding Path=Current.ResamplingMode, Mode=TwoWay, Source={x:Static local:SettingsManager.Instance}}"
                      SelectedValuePath="Tag" 
                      Height="30" VerticalContentAlignment="Center">
                <ComboBoxItem Content="{DynamicResource L_Settings_Advanced_Resampling_Option_Auto}" Tag="Auto"/>
                <ComboBoxItem Content="{DynamicResource L_Settings_Advanced_Resampling_Option_Bilinear}" Tag="Bilinear"/>
                <ComboBoxItem Content="{DynamicResource L_Settings_Advanced_Resampling_Option_Fant}" Tag="Fant"/>
                <ComboBoxItem Content="{DynamicResource L_Settings_Advanced_Resampling_Option_HighQuality}" Tag="HighQuality"/>
            </ComboBox>
        </Grid>

        <!-- ICC 颜色校正 -->
        <Grid Margin="0,5">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="Auto"/>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="Auto"/>
            </Grid.ColumnDefinitions>

            <StackPanel Grid.Column="0" VerticalAlignment="Center">
                <TextBlock Text="{DynamicResource L_Settings_Advanced_ICC_Title}"/>
                <TextBlock Text="{DynamicResource L_Settings_Advanced_ICC_Desc}" 
                           Foreground="{DynamicResource TextTertiaryBrush}" FontSize="11" Margin="0,2,0,0"/>
            </StackPanel>

            <CheckBox Grid.Column="2" Style="{StaticResource FluentCheckBoxStyle}" 
                      IsChecked="{Binding Path=Current.EnableIccColorCorrection, Mode=TwoWay, Source={x:Static local:SettingsManager.Instance}}"
                      VerticalAlignment="Center"/>
        </Grid>

        <Separator Margin="0,15" Background="{DynamicResource BorderLightBrush}"/>

        <!-- 像素阈值设置 -->
        <TextBlock Text="{DynamicResource L_Settings_Advanced_PixelThreshold_Title}" FontWeight="SemiBold" FontSize="14" Margin="0,0,0,5" Foreground="{DynamicResource TextPrimaryBrush}"/>
        <TextBlock Text="{DynamicResource L_Settings_Advanced_PixelThreshold_Desc}" 
                   Foreground="{DynamicResource TextTertiaryBrush}" FontSize="12" TextWrapping="Wrap" Margin="0,0,0,15"/>

        <!-- 看图模式阈值 -->
        <Grid Margin="0,10">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="100"/>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="70"/>
            </Grid.ColumnDefinitions>

            <TextBlock Text="{DynamicResource L_Settings_Advanced_PixelThreshold_ViewMode}" VerticalAlignment="Center"/>

            <Slider Grid.Column="1" Margin="0,0,10,0" Style="{StaticResource Win11HorizontalSliderStyle}"
                    Minimum="0" Maximum="100" 
                    SmallChange="1" LargeChange="10"
                    IsSnapToTickEnabled="False"
                    VerticalAlignment="Center"
                    Value="{Binding Path=Current.ViewInterpolationThreshold, Converter={StaticResource NonLinearConverter}, Mode=TwoWay, Source={x:Static local:SettingsManager.Instance}}"/>

            <TextBox Grid.Column="2" 
                     Text="{Binding Path=Current.ViewInterpolationThreshold, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged, StringFormat={}{0:0}, Source={x:Static local:SettingsManager.Instance}}"
                     LostFocus="TextBox_LostFocus"
                     PreviewTextInput="NumberValidationTextBox"
                     HorizontalContentAlignment="Right" 
                     VerticalAlignment="Center"
                     Height="24" Padding="0,2,4,0"/>
        </Grid>

        <!-- 画图模式阈值 -->
        <Grid Margin="0,10">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="100"/>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="70"/>
            </Grid.ColumnDefinitions>

            <TextBlock Text="{DynamicResource L_Settings_Advanced_PixelThreshold_PaintMode}" VerticalAlignment="Center"/>

            <Slider Grid.Column="1" Margin="0,0,10,0" Style="{StaticResource Win11HorizontalSliderStyle}"
                    Minimum="0" Maximum="100" 
                    SmallChange="1" LargeChange="10"
                    VerticalAlignment="Center"
                    Value="{Binding Path=Current.PaintInterpolationThreshold, Converter={StaticResource NonLinearConverter}, Mode=TwoWay, Source={x:Static local:SettingsManager.Instance}}"/>

            <TextBox Grid.Column="2" 
                     Text="{Binding Path=Current.PaintInterpolationThreshold, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged, StringFormat={}{0:0}, Source={x:Static local:SettingsManager.Instance}}"
                     PreviewTextInput="NumberValidationTextBox"
                     LostFocus="TextBox_LostFocus"
                     HorizontalContentAlignment="Right" 
                     VerticalAlignment="Center"
                     Height="24" Padding="0,2,4,0"/>
        </Grid>

        <Separator Margin="0,15" Background="{DynamicResource BorderLightBrush}"/>

        <!-- 撤销设置 -->
        <TextBlock Text="{DynamicResource L_Settings_Advanced_Undo_Header}" FontWeight="SemiBold" FontSize="16" Margin="0,5,0,10" Foreground="{DynamicResource TextPrimaryBrush}"/>

        <Grid Margin="0,5">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="320"/>
                <ColumnDefinition Width="100"/>
            </Grid.ColumnDefinitions>
            <StackPanel VerticalAlignment="Center">
                <TextBlock Text="{DynamicResource L_Settings_MaxGlobalUndoSteps}"/>
                <TextBlock Text="{DynamicResource L_Settings_MaxGlobalUndoSteps_Desc}" Foreground="{DynamicResource TextTertiaryBrush}" FontSize="11" Margin="0,2,0,0"/>
            </StackPanel>
            <TextBox Grid.Column="1" Margin="0,0,20,0" Width="80" HorizontalAlignment="Right" Height="28" VerticalContentAlignment="Center"
                     LostFocus="TextBox_LostFocus"
                     PreviewTextInput="NumberValidationTextBox"
                     Text="{Binding Path=Current.MaxGlobalUndoSteps, Mode=TwoWay, Source={x:Static local:SettingsManager.Instance}}"/>
        </Grid>

        <Grid Margin="0,5">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="320"/>
                <ColumnDefinition Width="100"/>
            </Grid.ColumnDefinitions>
            <StackPanel VerticalAlignment="Center">
                <TextBlock Text="{DynamicResource L_Settings_MaxUndoMemory}"/>
                <TextBlock Text="{DynamicResource L_Settings_MaxUndoMemory_Desc}" Foreground="{DynamicResource TextTertiaryBrush}" FontSize="11" Margin="0,2,0,0"/>
            </StackPanel>
            <Grid Grid.Column="1" Width="80" HorizontalAlignment="Right" Margin="0,0,20,0">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="32"/>
                </Grid.ColumnDefinitions>
                <TextBox x:Name="UndoMemoryTextBox" 
                         Style="{StaticResource LeftPartTextBoxStyle}"
                         Padding="4,0"
                         VerticalContentAlignment="Center"
                         LostFocus="UndoMemoryTextBox_LostFocus"
                         PreviewTextInput="NumberValidationTextBox"/>
                <Button x:Name="UnitToggleButton" 
                        Grid.Column="1" 
                        Content="MB"
                        Style="{StaticResource RightPartButtonStyle}"
                        Click="UnitToggleButton_Click"/>
            </Grid>
        </Grid>

        <Separator Margin="0,15" Background="{DynamicResource BorderLightBrush}"/>

        <!-- 习惯设置 -->
        <TextBlock Text="{DynamicResource L_Settings_Advanced_Habits_Header}" FontWeight="SemiBold" FontSize="16" Margin="0,15,0,10" Foreground="{DynamicResource TextPrimaryBrush}"/>

        <Grid Margin="0,5">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="Auto"/>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="Auto"/>
            </Grid.ColumnDefinitions>

            <StackPanel Grid.Column="0" VerticalAlignment="Center">
                <TextBlock Text="{DynamicResource L_Settings_Advanced_SkipResetConfirm_Title}"/>
                <TextBlock Text="{DynamicResource L_Settings_Advanced_SkipResetConfirm_Desc}" 
                           Foreground="{DynamicResource TextTertiaryBrush}" FontSize="11" Margin="0,2,0,0"/>
            </StackPanel>

            <CheckBox Grid.Column="2" Style="{StaticResource FluentCheckBoxStyle}" 
                      IsChecked="{Binding Path=Current.SkipResetConfirmation, Mode=TwoWay, Source={x:Static local:SettingsManager.Instance}}"
                      VerticalAlignment="Center"/>
        </Grid>

        <Grid Margin="0,5">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="Auto"/>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="Auto"/>
            </Grid.ColumnDefinitions>

            <StackPanel Grid.Column="0" VerticalAlignment="Center">
                <TextBlock Text="{DynamicResource L_Settings_Advanced_AlwaysShowTabClose_Title}"/>
                <TextBlock Text="{DynamicResource L_Settings_Advanced_AlwaysShowTabClose_Desc}" 
                           Foreground="{DynamicResource TextTertiaryBrush}" FontSize="11" Margin="0,2,0,0"/>
            </StackPanel>

            <CheckBox Grid.Column="2" Style="{StaticResource FluentCheckBoxStyle}" 
                      IsChecked="{Binding Path=Current.AlwaysShowTabCloseButton, Mode=TwoWay, Source={x:Static local:SettingsManager.Instance}}"
                      VerticalAlignment="Center"/>
        </Grid>

        <Separator Margin="0,15" Background="{DynamicResource BorderLightBrush}"/>
        <!-- 插件跳转入口 -->
        <TextBlock Text="{DynamicResource L_Settings_Nav_Plugins}" FontWeight="SemiBold" FontSize="16" Margin="0,5,0,10" Foreground="{DynamicResource TextPrimaryBrush}"/>
        <Grid Margin="0,0,0,10">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="Auto"/>
                <ColumnDefinition Width="*"/>
            </Grid.ColumnDefinitions>
            <Button Content="{DynamicResource L_Settings_Plugins_Install}" Width="120" Height="32" 
                    HorizontalAlignment="Left" Click="OpenPlugins_Click"
                    Style="{StaticResource Win11SecondaryButtonStyle}"
                    BorderThickness="1"/>

            <TextBlock Grid.Column="1" Text="{DynamicResource L_Settings_Plugins_Desc}" 
                       VerticalAlignment="Center" Margin="15,0,0,0" 
                       Foreground="{DynamicResource TextTertiaryBrush}" FontSize="11" TextWrapping="Wrap"/>
        </Grid>

        <Separator Margin="0,15" Background="{DynamicResource BorderLightBrush}"/>

        <!-- 维护设置 -->
        <TextBlock Text="{DynamicResource L_Settings_Advanced_Maintenance_Header}" FontWeight="SemiBold" FontSize="16" Margin="0,5,0,10" Foreground="{DynamicResource TextPrimaryBrush}"/>

        <Grid Margin="0,0,0,10">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="Auto"/>
                <ColumnDefinition Width="*"/>
            </Grid.ColumnDefinitions>
            <Button Content="{DynamicResource L_Settings_Advanced_OpenCache_Title}" Width="120" Height="32" 
                    HorizontalAlignment="Left" Click="OpenCacheFolder_Click"
                    Style="{StaticResource Win11SecondaryButtonStyle}"
                    BorderThickness="1"/>

            <TextBlock Grid.Column="1" Text="{DynamicResource L_Settings_Advanced_OpenCache_Desc}" 
                       VerticalAlignment="Center" Margin="15,0,0,0" 
                       Foreground="{DynamicResource TextTertiaryBrush}"/>
        </Grid>

        <Grid>
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="Auto"/>
                <ColumnDefinition Width="*"/>
            </Grid.ColumnDefinitions>
            <Button Content="{DynamicResource L_Settings_Advanced_FactoryReset}" Width="120" Height="32" 
                    HorizontalAlignment="Left" Click="FactoryReset_Click"
                    Background="{DynamicResource ButtonBackgroundBrush}" 
                    Foreground="{DynamicResource DangerBrush}" 
                    BorderBrush="{DynamicResource DangerBrush}"
                    Style="{StaticResource Win11SecondaryButtonStyle}"
                    BorderThickness="1"/>

            <TextBlock Grid.Column="1" Text="{DynamicResource L_Settings_Advanced_FactoryReset_Button}" 
                       VerticalAlignment="Center" Margin="15,0,0,0" 
                       Foreground="{DynamicResource TextTertiaryBrush}"/>
        </Grid>

    </StackPanel>
</UserControl>

<Window x:Class="TabPaint.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:local="clr-namespace:TabPaint" 
        xmlns:controls="clr-namespace:TabPaint.Controls"
        xmlns:System="clr-namespace:System;assembly=mscorlib"
        xmlns:shell="clr-namespace:System.Windows.Shell;assembly=PresentationFramework"
        xmlns:gif="https://github.com/XamlAnimatedGif/XamlAnimatedGif"
        Title="TabPaint"
        Height="700" Width="850"
        MinHeight="345" MinWidth="430"
        Top="100" Left="100"
        SizeToContent="Manual"
        AllowsTransparency="False" 
        Background="{DynamicResource WindowBackgroundBrush}"
        Closing="Window_Closing"
        WindowStyle="None"
        SizeChanged="Window_SizeChanged" 
        PreviewKeyUp="Window_KeyUp"
        x:Name="RootWindow">

    <WindowChrome.WindowChrome>
        <shell:WindowChrome 
            GlassFrameThickness="-1" 
            CaptionHeight="32"
            ResizeBorderThickness="4"
            CornerRadius="0"/>
    </WindowChrome.WindowChrome>
    <Window.Resources>
        <ResourceDictionary>
            <ResourceDictionary.MergedDictionaries>
                <!-- 确保 App.xaml 或此处正确加载了 LightTheme.xaml -->
                <ResourceDictionary Source="pack://application:,,,/Resources/Styles.xaml"/>
            </ResourceDictionary.MergedDictionaries>
            <BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter"/>
            <local:InverseBooleanToVisibilityConverter x:Key="InverseBoolToVis"/>
            <local:ZoomToInverseValueConverter x:Key="ZoomToInverseValueConverter"/>
            <Style x:Key="RulerVisibilityStyle" TargetType="{x:Type local:Ruler}">
                <Setter Property="Visibility" Value="Collapsed"/>
          
                <!-- 默认隐藏 -->
                <Style.Triggers>
                    <MultiDataTrigger>
                        <MultiDataTrigger.Conditions>
                            <Condition Binding="{Binding ShowRulers}" Value="True"/>
                            <Condition Binding="{Binding IsViewMode, ElementName=RootWindow}" Value="False"/>
                        </MultiDataTrigger.Conditions>
                        <Setter Property="Visibility" Value="Visible"/>
                    </MultiDataTrigger>
                </Style.Triggers>
            </Style>
        </ResourceDictionary>
        
    </Window.Resources>

    <!-- 主容器背景 -->
    <Grid Background="Transparent" PreviewDragOver="OnGlobalDragOver"
          PreviewDrop="OnGlobalDrop"
          PreviewDragLeave="OnGlobalDragLeave">
        <DockPanel LastChildFill="True">

            <!-- #region 1. 自定义标题栏 (TitleBar) -->
            <controls:TitleBarControl x:Name="AppTitleBar" 
                          DockPanel.Dock="Top" 
                          MinimizeClick="Minimize_Click"
                          MaximizeRestoreClick="MaximizeRestore_Click"
                          CloseClick="Close_Click"
                          TitleBarMouseDown="Border_MouseLeftButtonDown"
                          ModeSwitchClick="OnTitleBarModeSwitch" />
            <!-- #endregion -->

            <!-- #region 2. 菜单栏 (MenuBar) -->
            <ContentControl x:Name="MenuBarHolder" DockPanel.Dock="Top"
                Visibility="{Binding IsViewMode, ElementName=RootWindow, Converter={StaticResource InverseBoolToVis}}"/>
            <!-- #endregion -->

            <!-- 分割线 -->
            <Rectangle DockPanel.Dock="Top" Height="1" Fill="{DynamicResource BorderLightBrush}" SnapsToDevicePixels="True"        
                       Visibility="{Binding IsViewMode, ElementName=RootWindow, Converter={StaticResource InverseBoolToVis}}"/>

            <!-- #region 3. 工具栏 (ToolBar) -->
            <ContentControl x:Name="ToolBarHolder" DockPanel.Dock="Top"
                Visibility="{Binding IsViewMode, ElementName=RootWindow, Converter={StaticResource InverseBoolToVis}}"/>
            <!-- #endregion -->

            <!-- #region 4. 图片列表栏 (ImageBar) -->
            <ContentControl x:Name="ImageBarHolder" DockPanel.Dock="Top"
                IsTabStop="False" Focusable="False"/>
            <!-- #endregion -->

            <Rectangle DockPanel.Dock="Top" Height="1" Fill="{DynamicResource BorderLightBrush}" SnapsToDevicePixels="True"  
                       Visibility="{Binding IsViewMode, ElementName=RootWindow, Converter={StaticResource InverseBoolToVis}}"/>

            <!-- #region 5. 底部状态栏 (StatusBar) -->
            <ContentControl x:Name="StatusBarHolder" DockPanel.Dock="Bottom"
                Visibility="{Binding IsViewMode, ElementName=RootWindow, Converter={StaticResource InverseBoolToVis}}"/>
            <!-- #endregion -->

            <Rectangle DockPanel.Dock="Bottom" Height="1" Fill="{DynamicResource BorderLightBrush}" SnapsToDevicePixels="True"/>

            <!-- #region 6. 主画布区域 (Canvas) -->
            <Grid ClipToBounds="False" Background="Transparent">
                <Grid.Resources>
                    <local:ScaleToTileRectConverter x:Key="ScaleToTileRectConverter"/>
                </Grid.Resources>

                <Grid ClipToBounds="False">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="*"/>
                    </Grid.ColumnDefinitions>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                    </Grid.RowDefinitions>

                    <!-- 顶部标尺 -->
                    <local:Ruler x:Name="RulerTop" Grid.Row="0" Grid.Column="1" Height="20" 
                                 Orientation="Horizontal"      
                                 Style="{StaticResource RulerVisibilityStyle}"
/>

                    <!-- 左侧标尺 -->
                    <local:Ruler x:Name="RulerLeft" Grid.Row="1" Grid.Column="0" Width="20" 
                                 Orientation="Vertical"
                                   Style="{StaticResource RulerVisibilityStyle}"/>

                    <!-- 左上角的小方块 (标尺交汇处) -->
                    <!-- 原色 #20F0F0F0，这里用 ChromeMediumBrush (#F0F0F0) 配合透明度 -->
                    <Border Grid.Row="0" Grid.Column="0" 
        Background="{DynamicResource ChromeMediumBrush}" Opacity="0.12">
                        <Border.Style>
                            <Style TargetType="Border">
                                <Setter Property="Visibility" Value="Collapsed"/>
                                <Style.Triggers>
                                    <!-- 联动顶部标尺的显示状态 -->
                                    <DataTrigger Binding="{Binding Visibility, ElementName=RulerTop}" Value="Visible">
                                        <Setter Property="Visibility" Value="Visible"/>
                                    </DataTrigger>
                                </Style.Triggers>
                            </Style>
                        </Border.Style>
                    </Border>


                    <ScrollViewer Grid.Row="1" Grid.Column="1" ContextMenuOpening="OnScrollContainerContextMenuOpening"  
                                  Style="{StaticResource FluentScrollViewer}" Name="ScrollContainer" 
                                  FocusVisualStyle="{x:Null}" HorizontalScrollBarVisibility="Auto" VerticalScrollBarVisibility="Auto" 
                                  PreviewMouseWheel="OnMouseWheelZoom" Background="Transparent" 
                                  PreviewMouseDown="OnScrollContainerMouseDown" PreviewMouseMove="OnScrollContainerMouseMove"  
                                  PreviewMouseUp="OnScrollContainerMouseUp" MouseDoubleClick="OnScrollContainerDoubleClick" 
                                  AllowDrop="True" ScrollChanged="ScrollContainer_ScrollChanged" >
                        <ScrollViewer.ContextMenu>
                            <ContextMenu Style="{StaticResource Win11ContextMenuStyle}">
                                <MenuItem Header="复制" InputGestureText="Ctrl+C" Style="{StaticResource Win11MenuItemStyle}" Click="OnCopyClick">
                                    <MenuItem.Icon>
                                        <Path Data="{DynamicResource Copy_Image}" Stretch="Uniform" Fill="{DynamicResource IconFillBrush}" Width="16" Height="16"/>
                                    </MenuItem.Icon>
                                </MenuItem>
                                <MenuItem Header="剪切" InputGestureText="Ctrl+V" Style="{StaticResource Win11MenuItemStyle}" Click="OnCutClick">
                                    <MenuItem.Icon>
                                        <Path Data="{DynamicResource Cut_Image}" Stretch="Uniform" Fill="{DynamicResource IconFillBrush}" Width="16" Height="16"/>
                                    </MenuItem.Icon>
                                </MenuItem>
                                <MenuItem Header="粘贴" InputGestureText="Ctrl+V" Style="{StaticResource Win11MenuItemStyle}" Click="OnPasteClick">
                                    <MenuItem.Icon>
                                        <Path Data="{DynamicResource Paste_Image}" Stretch="Uniform" Fill="{DynamicResource IconFillBrush}" Width="16" Height="16"/>
                                    </MenuItem.Icon>
                                </MenuItem>

                                <Separator Style="{StaticResource Win11MenuSeparatorStyle}"/>
                                <MenuItem Header="固定缩放倍数" 
                                          IsCheckable="True" 
                                          Style="{StaticResource Win11MenuItemStyle}"
                                          DataContext="{Binding Source={x:Static local:SettingsManager.Instance}, Path=Current}"
                                          IsChecked="{Binding IsFixedZoom, Mode=TwoWay}">
                                    <MenuItem.Icon>
                                        <Path Data="{DynamicResource Pin_Image}" Stretch="Uniform" Fill="{DynamicResource IconFillBrush}" Width="16" Height="16"/>
                                    </MenuItem.Icon>
                                </MenuItem>
                                <MenuItem Header="显示标尺" IsCheckable="True" 
                                          IsChecked="{Binding ShowRulers, Mode=TwoWay}"
                                          Style="{StaticResource Win11MenuItemStyle}">
                                    <MenuItem.Icon>
                                        <TextBlock Text="📏" FontFamily="Segoe UI Emoji" Foreground="{DynamicResource TextPrimaryBrush}"/>
                                    </MenuItem.Icon>
                                </MenuItem>
                                <Separator Style="{StaticResource Win11MenuSeparatorStyle}"/>

                                <!-- 二级菜单：小工具 -->
                                <MenuItem x:Name="miniTools" Header="小工具" Style="{StaticResource Win11MenuItemStyle}">
                                    <MenuItem.Icon>
                                        <Path Data="{DynamicResource Wrench_Image}" Stretch="Uniform" Fill="{DynamicResource IconFillBrush}" Width="16" Height="16"/>
                                    </MenuItem.Icon>

                                    <MenuItem Header="AI 一键抠图 (RMBG)" Style="{StaticResource Win11MenuItemStyle}" InputGestureText="Ctrl+Alt+1"  Click="OnRemoveBackgroundClick">
                                        <MenuItem.Icon>
                                            <TextBlock Text="🪄" FontFamily="Segoe UI Emoji" Foreground="{DynamicResource TextPrimaryBrush}"/>
                                        </MenuItem.Icon>
                                    </MenuItem>

                                    <MenuItem Header="色差抠图 (去除背景)" Style="{StaticResource Win11MenuItemStyle}" InputGestureText="Ctrl+Alt+2"  Click="OnChromaKeyClick">
                                        <MenuItem.Icon>
                                            <TextBlock Text="🪄" FontFamily="Segoe UI Emoji" Foreground="{DynamicResource TextPrimaryBrush}"/>
                                        </MenuItem.Icon>
                                    </MenuItem>

                                    <MenuItem Header="提取图中文字 (OCR)" Style="{StaticResource Win11MenuItemStyle}" InputGestureText="Ctrl+Alt+3"  Click="OnOcrClick">
                                        <MenuItem.Icon>
                                            <TextBlock Text="&#xE8C6;" FontFamily="Segoe Fluent Icons" Foreground="{DynamicResource TextPrimaryBrush}"/>
                                        </MenuItem.Icon>
                                    </MenuItem>

                                    <MenuItem Header="屏幕取色器" Style="{StaticResource Win11MenuItemStyle}"  InputGestureText="Ctrl+Alt+4"  Click="OnScreenColorPickerClick">
                                        <MenuItem.Icon>
                                            <TextBlock Text="🖌️" FontFamily="Segoe UI Emoji" Foreground="{DynamicResource TextPrimaryBrush}"/>
                                        </MenuItem.Icon>
                                    </MenuItem>

                                    <MenuItem Header="复制颜色代码 (#HEX)" Style="{StaticResource Win11MenuItemStyle}"  InputGestureText="Ctrl+Alt+5"  Click="OnCopyColorCodeClick">
                                        <MenuItem.Icon>
                                            <TextBlock Text="🎨" FontFamily="Segoe UI Emoji" Foreground="{DynamicResource TextPrimaryBrush}"/>
                                        </MenuItem.Icon>
                                    </MenuItem>
                                    <MenuItem Header="智能裁切空白" Style="{StaticResource Win11MenuItemStyle}"  InputGestureText="Ctrl+Alt+6"  Click="OnAutoCropClick">
                                        <MenuItem.Icon>
                                            <TextBlock Text="✂" FontFamily="Segoe UI Emoji" Foreground="{DynamicResource TextPrimaryBrush}"/>
                                        </MenuItem.Icon>
                                    </MenuItem>
                                    <MenuItem Header="一键加边框 (2px)" Style="{StaticResource Win11MenuItemStyle}" InputGestureText="Ctrl+Alt+7" Click="OnAddBorderClick">
                                        <MenuItem.Icon>
                                            <Border BorderBrush="{DynamicResource IconFillBrush}" BorderThickness="2" Width="14" Height="14" CornerRadius="1"/>
                                        </MenuItem.Icon>
                                    </MenuItem>
                                </MenuItem>
                            </ContextMenu>
                        </ScrollViewer.ContextMenu>

                        <Grid HorizontalAlignment="Center" VerticalAlignment="Center" Margin="5" ClipToBounds="False">
                            <Grid Name="CanvasWrapper" ClipToBounds="False" HorizontalAlignment="Center" VerticalAlignment="Center" SnapsToDevicePixels="True" UseLayoutRounding="True">
                                <Grid.Background>
                                    <DrawingBrush TileMode="Tile" ViewportUnits="Absolute">
                                        <DrawingBrush.Viewport>
                                            <Binding ElementName="ZoomTransform" Path="ScaleX" 
                                                     Converter="{StaticResource ScaleToTileRectConverter}" 
                                                     ConverterParameter="20"/>
                                        </DrawingBrush.Viewport>
                                        <DrawingBrush.Drawing>
                                            <DrawingGroup>
                                                <GeometryDrawing Brush="{DynamicResource ChromeMediumBrush}">
                                                    <GeometryDrawing.Geometry>
                                                        <RectangleGeometry Rect="0,0,20,20"/>
                                                    </GeometryDrawing.Geometry>
                                                </GeometryDrawing>
                                                <GeometryDrawing Brush="{DynamicResource CheckerboardDarkBrush}">
                                                    <GeometryDrawing.Geometry>
                                                        <GeometryGroup>
                                                            <RectangleGeometry Rect="0,0,10,10"/>
                                                            <RectangleGeometry Rect="10,10,10,10"/>
                                                        </GeometryGroup>
                                                    </GeometryDrawing.Geometry>
                                                </GeometryDrawing>
                                            </DrawingGroup>
                                        </DrawingBrush.Drawing>
                                    </DrawingBrush>
                                </Grid.Background>

                                <Grid.LayoutTransform>
                                    <ScaleTransform x:Name="ZoomTransform" ScaleX="1" ScaleY="1" />
                                </Grid.LayoutTransform>
                                <Grid Name="ImageContentLayer" ClipToBounds="True">
                                    <!-- 2. 只有边框的层 -->
                                <Image Name="PreviewImage" 
                                     Stretch="Fill" 
                                     Width="{Binding ElementName=BackgroundImage, Path=ActualWidth}"
                                     Height="{Binding ElementName=BackgroundImage, Path=ActualHeight}"
                                     HorizontalAlignment="Left" 
                                     VerticalAlignment="Top" 
                                     IsHitTestVisible="False" 
                                     Visibility="Collapsed"
                                     RenderOptions.BitmapScalingMode="Linear"/>
                                <!-- 1. 基础图片 -->
                                <Image Name="BackgroundImage" Stretch="None" HorizontalAlignment="Left" VerticalAlignment="Top" SnapsToDevicePixels="True" RenderOptions.BitmapScalingMode="NearestNeighbor" />

                                <Image Name="GifPlayerImage"
                                       Stretch="None"
                                       HorizontalAlignment="Left"
                                       VerticalAlignment="Top"
                                       SnapsToDevicePixels="True"
                                       Visibility="Collapsed"
                                       gif:AnimationBehavior.AutoStart="True"
                                       gif:AnimationBehavior.RepeatBehavior="Forever" />
                                    <Canvas Name="EditorOverlayCanvas" Background="Transparent" IsHitTestVisible="False" Visibility="Visible"/>
                                    <!-- 3. 选区预览层 -->
                                <Image Name="SelectionPreview" Stretch="Fill" HorizontalAlignment="Left" VerticalAlignment="Top" IsHitTestVisible="False" RenderOptions.BitmapScalingMode="NearestNeighbor" UseLayoutRounding="True" RenderOptions.EdgeMode="Aliased" Margin="0" SnapsToDevicePixels="True" Visibility="Collapsed"/>
                                </Grid>
                                <!-- 5. 编辑器层 -->
                              
                            </Grid>
                            <Canvas Name="SelectionOverlayCanvas" 
                                    Panel.ZIndex="100" 
                                    Visibility="Collapsed" 
                                    IsHitTestVisible="False" 
                                    Background="Transparent" 
                                    UseLayoutRounding="False" 
                                    SnapsToDevicePixels="False">

                                <Canvas.LayoutTransform>
                                    <Binding ElementName="CanvasWrapper" Path="LayoutTransform"/>
                                </Canvas.LayoutTransform>
                                <Canvas.Width>
                                    <Binding ElementName="BackgroundImage" Path="ActualWidth"/>
                                </Canvas.Width>
                                <Canvas.Height>
                                    <Binding ElementName="BackgroundImage" Path="ActualHeight"/>
                                </Canvas.Height>
                            </Canvas>

                            <Border Name="StaticCanvasBorder"
                                    Visibility="{Binding IsViewMode, ElementName=RootWindow, Converter={StaticResource InverseBoolToVis}}"
                                    IsHitTestVisible="False"
                                    SnapsToDevicePixels="True"
                                    UseLayoutRounding="True"
                                    HorizontalAlignment="Stretch" 
                                    VerticalAlignment="Stretch"
                                    BorderBrush="{DynamicResource BorderLightBrush}" 
                                    BorderThickness="1">
                                <Border.Margin>
                                    <Thickness Left="-1" Top="-1" Right="-1" Bottom="-1"/>
                                </Border.Margin>
                                <Border.Style>
                                    <Style TargetType="Border">
                                        <Setter Property="Effect" Value="{x:Null}"/>
                                        <Style.Triggers>
                                            <DataTrigger Binding="{Binding IsViewMode, ElementName=RootWindow}" Value="False">
                                                <Setter Property="Effect">
                                                    <Setter.Value>
                                                        <!-- 阴影颜色保持黑色，通常不随主题变化 -->
                                                        <DropShadowEffect Color="Black" 
                                                                          Direction="270" 
                                                                          ShadowDepth="0" 
                                                                          BlurRadius="20" 
                                                                          Opacity="0.25" 
                                                                          RenderingBias="Performance"/>
                                                    </Setter.Value>
                                                </Setter>
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </Border.Style>
                            </Border>
                            <Canvas Name="CanvasResizeOverlay" 
                                    Visibility="Visible" 
                                    IsHitTestVisible="True" 
                                    Background="{x:Null}"  
                                    UseLayoutRounding="False"
                                    SnapsToDevicePixels="False"
                                    ClipToBounds="False">
                                <Canvas.LayoutTransform>
                                    <Binding ElementName="CanvasWrapper" Path="LayoutTransform"/>
                                </Canvas.LayoutTransform>
                            </Canvas>
                        </Grid>
                    </ScrollViewer>
                </Grid>

                <!-- 粗细预览圆 Stroke="Purple" -> ToolAccentBrush -->
                <Rectangle x:Name="ThicknessPreview" 
                           IsHitTestVisible="False" 
                           Fill="Transparent" 
                           Stroke="{DynamicResource ToolAccentBrush}" 
                           StrokeThickness="2" 
                           Width="40" Height="40" 
                           Visibility="Collapsed" 
                           Opacity="0.6" 
                           StrokeDashArray="3 2" 
                           HorizontalAlignment="Center" 
                           VerticalAlignment="Center"/>

                <Grid x:Name="ToolPanelGrid" HorizontalAlignment="Left" VerticalAlignment="Stretch" Margin="15,20,0,5" Width="42" Panel.ZIndex="100">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="1*"/>
                        <RowDefinition Height="10000*" MaxHeight="280" MinHeight="140"/>
                        <RowDefinition Height="15"/>
                        <RowDefinition Height="10000*" MaxHeight="280" MinHeight="140"/>
                        <RowDefinition Height="1*"/>
                    </Grid.RowDefinitions>

                    <!-- 背景色和边框色统一 -->
                    <Border Grid.Row="1" x:Name="ThicknessPanel" CornerRadius="12" 
                            Background="{DynamicResource PanelBackgroundBrush}" 
                            BorderBrush="{DynamicResource BorderMediumBrush}" 
                            BorderThickness="1">
                        <Border.Resources>
                            <local:DynamicRangeConverter x:Key="DynamicSizeConverter"/>
                        </Border.Resources>
                        <Border.Effect>
                            <DropShadowEffect BlurRadius="15" Opacity="0.15" ShadowDepth="2"/>
                        </Border.Effect>
                        <Grid>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="*"/>
                            </Grid.RowDefinitions>
                            <!-- 图标 -->
                            <Image Grid.Row="0" Source="{DynamicResource Stroke_Width_Image}" Margin="0,12,0,4" Width="16" Height="16"/>

                            <!-- Slider Tooltip 颜色统一 -->
                            <Slider Grid.Row="1" x:Name="ThicknessSlider" 
                Style="{StaticResource Win11VerticalSliderStyle}" 
                Orientation="Vertical" 
                Minimum="0" Maximum="1"
                SmallChange="0.005" LargeChange="0.05"
                IsSnapToTickEnabled="False"
                Margin="0,0,0,10"
                Thumb.DragStarted="ThicknessSlider_DragStarted" 
                Thumb.DragCompleted="ThicknessSlider_DragCompleted" 
                ValueChanged="ThicknessSlider_ValueChanged">

                                <Slider.Value>
                                    <MultiBinding Converter="{StaticResource DynamicSizeConverter}" Mode="TwoWay">
                                        <!-- 绑定参数 1: 粗细数值 -->
                                        <Binding Source="{x:Static local:SettingsManager.Instance}" Path="Current.PenThickness" Mode="TwoWay"/>
                                        <!-- 绑定参数 2: 工具 Key (用于触发上限更新) -->
                                        <Binding Source="{x:Static local:SettingsManager.Instance}" Path="Current.CurrentToolKey" Mode="OneWay"/>
                                    </MultiBinding>
                                </Slider.Value>

                                <Slider.ToolTip>
                                    <ToolTip Background="{DynamicResource TextPrimaryBrush}" Foreground="{DynamicResource TextInverseBrush}" BorderThickness="0" Padding="8,4">
                                        <StackPanel Orientation="Horizontal">
                                            <!-- Tooltip 保持简单绑定即可，因为它只负责显示结果 -->
                                            <TextBlock Text="{Binding Source={x:Static local:SettingsManager.Instance}, Path=Current.PenThickness, StringFormat={}{0:F0}}"/>
                                            <TextBlock Text=" 像素" Margin="2,0,0,0"/>
                                        </StackPanel>
                                    </ToolTip>
                                </Slider.ToolTip>
                            </Slider>
                        </Grid>
                    </Border>

                    <Border Grid.Row="3" x:Name="OpacityPanel" CornerRadius="12" 
                            Background="{DynamicResource PanelBackgroundBrush}" 
                            BorderBrush="{DynamicResource BorderMediumBrush}" 
                            BorderThickness="1">
                        <Border.Effect>
                            <DropShadowEffect BlurRadius="15" Opacity="0.15" ShadowDepth="2"/>
                        </Border.Effect>
                        <Grid>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="*"/>
                            </Grid.RowDefinitions>

                            <!-- 图标 -->
                            <Image Grid.Row="0" Source="{DynamicResource Opacity_Image}" Margin="0,12,0,4" Width="16" Height="16"/>

                            <Slider Grid.Row="1" x:Name="OpacitySlider" 
                                    Style="{StaticResource Win11VerticalSliderStyle}" 
                                    Orientation="Vertical" 
                                    Minimum="0" Maximum="1" 
                                    SmallChange="0.05" LargeChange="0.1"
                                    DataContext="{Binding Source={x:Static local:SettingsManager.Instance}, Path=Current}"
                                    Value="{Binding PenOpacity, Mode=TwoWay}" 
                                    Margin="0,0,0,10"
                                    IsSnapToTickEnabled="False"
                                    Loaded="OpacitySlider_Loaded"  
                                    Thumb.DragStarted="OpacitySlider_DragStarted"
                                    Thumb.DragCompleted="OpacitySlider_DragCompleted"
                                    ValueChanged="OpacitySlider_ValueChanged">
                                <Slider.ToolTip>
                                    <ToolTip x:Name="OpacityToolTip" Background="{DynamicResource TextPrimaryBrush}" Foreground="{DynamicResource TextInverseBrush}" BorderThickness="0" Padding="8,4" Placement="Right" HorizontalOffset="10">
                                        <StackPanel Orientation="Horizontal">
                                            <TextBlock Text="{Binding PenOpacity, StringFormat={}{0:P0}, UpdateSourceTrigger=PropertyChanged}"/>
                                            <TextBlock Text="" Margin="2,0,0,0"/>
                                        </StackPanel>
                                    </ToolTip>
                                </Slider.ToolTip>
                            </Slider>
                        </Grid>
                    </Border>

                </Grid>

                <Border x:Name="BirdEyePanel" 
                        HorizontalAlignment="Right" VerticalAlignment="Bottom"
                        Margin="0,0,25,25"
                        Width="140" Height="120"
                        Background="{DynamicResource ControlBackgroundBrush}"
                        BorderBrush="{DynamicResource BorderMediumBrush}" BorderThickness="1"
                        CornerRadius="4"
                        Visibility="Collapsed">

                    <Border.Effect>
                        <DropShadowEffect BlurRadius="10" Opacity="0.2" ShadowDepth="2"/>
                    </Border.Effect>

                    <Grid Margin="5">
                        <!-- 1. 缩略图底图 -->
                        <Image x:Name="BirdEyeImage" Stretch="Uniform" 
                               Source="{Binding ElementName=BackgroundImage, Path=Source}"
                               HorizontalAlignment="Center" VerticalAlignment="Center"/>

                        <!-- 2. 交互层 Canvas -->
                        <Canvas x:Name="BirdEyeCanvas" 
                                Background="Transparent"
                                Width="{Binding ElementName=BirdEyeImage, Path=ActualWidth}"
                                Height="{Binding ElementName=BirdEyeImage, Path=ActualHeight}"
                                HorizontalAlignment="Center" VerticalAlignment="Center"
                                MouseDown="BirdEyeCanvas_MouseDown"
                                MouseMove="BirdEyeCanvas_MouseMove"
                                MouseUp="BirdEyeCanvas_MouseUp">

                            <!-- 3. 视野框 (Viewport Rect) -->
                            <!-- 背景色模拟透明蓝 #200078D7 -->
                            <Border x:Name="BirdEyeViewport" 
                                    BorderBrush="{DynamicResource SystemAccentHoverBrush}" 
                                    BorderThickness="2" 
                                    Background="{DynamicResource SystemAccentHoverBrush}"
                                    Opacity="0.2"
                                    IsHitTestVisible="False"/>
                        </Canvas>
                    </Grid>
                </Border>
            </Grid>
            <!-- #endregion -->
        </DockPanel>

        <!-- #region 7. 悬浮面板 (Floating UI) -->
        <!-- 文本编辑条 -->
        <Border x:Name="TextEditBar" Visibility="Collapsed" MouseDown="TextEditBar_MouseDown" MouseMove="TextEditBar_MouseMove"
                MouseUp="TextEditBar_MouseUp" HorizontalAlignment="Center" VerticalAlignment="Top" Margin="0,80,0,0" 
                Background="{DynamicResource ChromeLowBrush}" 
                BorderBrush="{DynamicResource BorderLightBrush}" 
                BorderThickness="1" CornerRadius="8" Padding="6">
            <Border.RenderTransform>
                <TranslateTransform x:Name="TextBarDragTransform" X="0" Y="0"/>
            </Border.RenderTransform>
            <Border.Effect>
                <DropShadowEffect BlurRadius="12" ShadowDepth="4" Direction="270" Color="Black" Opacity="0.1"/>
            </Border.Effect>
            <StackPanel Orientation="Horizontal">
                <!-- 字体选择 -->
                <ComboBox x:Name="FontFamilyBox" 
                          Style="{StaticResource FluentComboBoxStyle}" 
                          Width="160" 
                          IsEditable="True" 
                          Background="{DynamicResource ControlBackgroundBrush}"
                          SelectionChanged="FontSettingChanged" 
                          TextBoxBase.TextChanged="FontSettingChanged">
                </ComboBox>
                <!-- 字号 -->
                <ComboBox x:Name="FontSizeBox" Style="{StaticResource FluentComboBoxStyle}" Width="70" 
                          IsEditable="True" Text="24"
                          SelectionChanged="FontSettingChanged" TextBoxBase.TextChanged="FontSettingChanged">
                    <System:Double>9</System:Double>
                    <System:Double>10</System:Double>
                    <System:Double>11</System:Double>
                    <System:Double>12</System:Double>
                    <System:Double>14</System:Double>
                    <System:Double>18</System:Double>
                    <System:Double>24</System:Double>
                    <System:Double>36</System:Double>
                    <System:Double>48</System:Double>
                    <System:Double>64</System:Double>
                    <System:Double>72</System:Double>
                    <System:Double>96</System:Double>
                </ComboBox>

                <Rectangle Width="1" Height="20" Fill="{DynamicResource BorderBrush}" Margin="4,0,8,0"/>

                <!-- 基础样式 -->
                <ToggleButton x:Name="BoldBtn" Style="{StaticResource FluentToggleButtonStyle}" Click="FontSettingChanged" ToolTip="加粗">
                    <TextBlock Text="B" FontWeight="Bold" FontFamily="Segoe UI" FontSize="16" Foreground="{DynamicResource TextPrimaryBrush}"/>
                </ToggleButton>
                <ToggleButton x:Name="ItalicBtn" Style="{StaticResource FluentToggleButtonStyle}" Click="FontSettingChanged" ToolTip="斜体">
                    <TextBlock Text="I" FontStyle="Italic" FontFamily="Times New Roman" FontSize="16" Foreground="{DynamicResource TextPrimaryBrush}"/>
                </ToggleButton>
                <ToggleButton x:Name="UnderlineBtn" Style="{StaticResource FluentToggleButtonStyle}" Click="FontSettingChanged" ToolTip="下划线">
                    <TextBlock Text="U" TextDecorations="Underline" FontFamily="Segoe UI" FontSize="16" Foreground="{DynamicResource TextPrimaryBrush}"/>
                </ToggleButton>
                <ToggleButton x:Name="StrikeBtn" Style="{StaticResource FluentToggleButtonStyle}" Click="FontSettingChanged" ToolTip="删除线">
                    <TextBlock Text="S" TextDecorations="Strikethrough" FontFamily="Segoe UI" FontSize="16" Foreground="{DynamicResource TextPrimaryBrush}"/>
                </ToggleButton>

                <Rectangle Width="1" Height="20" Fill="{DynamicResource BorderBrush}" Margin="8,0,8,0"/>

                <!-- 对齐方式 -->
                <ToggleButton x:Name="AlignLeftBtn" Style="{StaticResource FluentToggleButtonStyle}" Click="TextAlign_Click" Tag="Left" IsChecked="True" ToolTip="左对齐">
                    <Path Data="M0,2 L14,2 M0,6 L10,6 M0,10 L14,10 M0,14 L10,14" Stroke="{DynamicResource IconFillBrush}" StrokeThickness="1" Width="14" Height="14" VerticalAlignment="Center" HorizontalAlignment="Center"/>
                </ToggleButton>
                <ToggleButton x:Name="AlignCenterBtn" Style="{StaticResource FluentToggleButtonStyle}" Click="TextAlign_Click" Tag="Center" ToolTip="居中">
                    <Path Data="M0,2 L14,2 M2,6 L12,6 M0,10 L14,10 M2,14 L12,14" Stroke="{DynamicResource IconFillBrush}" StrokeThickness="1" Width="14" Height="14" VerticalAlignment="Center" HorizontalAlignment="Center"/>
                </ToggleButton>
                <ToggleButton x:Name="AlignRightBtn" Style="{StaticResource FluentToggleButtonStyle}" Click="TextAlign_Click" Tag="Right" ToolTip="右对齐">
                    <Path Data="M0,2 L14,2 M4,6 L14,6 M0,10 L14,10 M4,14 L14,14" Stroke="{DynamicResource IconFillBrush}" StrokeThickness="1" Width="14" Height="14" VerticalAlignment="Center" HorizontalAlignment="Center"/>
                </ToggleButton>

                <Rectangle Width="1" Height="20" Fill="{DynamicResource BorderBrush}" Margin="8,0,8,0"/>

                <!-- 背景填充 -->
                <ToggleButton x:Name="TextBackgroundBtn" Style="{StaticResource FluentToggleButtonStyle}" Click="FontSettingChanged" ToolTip="不透明背景">
                    <Grid>
                        <Rectangle Width="14" Height="14" Fill="{DynamicResource ControlBackgroundBrush}" Stroke="{DynamicResource IconFillBrush}" StrokeThickness="1"/>
                        <TextBlock Text="A" FontSize="10" HorizontalAlignment="Center" VerticalAlignment="Center" FontWeight="Bold" Foreground="{DynamicResource TextPrimaryBrush}"/>
                    </Grid>
                </ToggleButton>

            </StackPanel>
        </Border>

        <!-- 粗细提示 -->
        <Border x:Name="ThicknessTip" Background="{DynamicResource TextControlBrush}" CornerRadius="4" Padding="6,2" HorizontalAlignment="Left" VerticalAlignment="Top" Margin="30,0,0,0" Visibility="Collapsed">
            <TextBlock x:Name="ThicknessTipText" Foreground="{DynamicResource TextInverseBrush}" FontSize="12" TextWrapping="NoWrap" TextAlignment="Center"/>
        </Border>

        <!-- 通知层 -->
        <!-- Toast 背景模拟：#A0444444 -> TextControlBrush (#333) with Opacity -->
        <Grid x:Name="NotificationLayer" VerticalAlignment="Bottom" HorizontalAlignment="Center" Margin="0,0,0,120" IsHitTestVisible="False">
            <Border x:Name="InfoToast" Background="{DynamicResource TextControlBrush}" CornerRadius="20" Padding="20,8" Opacity="0">
                <Border.Effect>
                    <DropShadowEffect BlurRadius="10" ShadowDepth="0" Opacity="0.3"/>
                </Border.Effect>
                <TextBlock x:Name="InfoToastText" Text="提示信息" Foreground="{DynamicResource TextInverseBrush}" FontSize="14" VerticalAlignment="Center"/>
            </Border>
        </Grid>
        <!-- #endregion -->

        <!-- #region 8. 拖拽遮罩层 (Drag Overlay) -->
        <Grid x:Name="DragOverlay" Visibility="Collapsed" IsHitTestVisible="False" Background="#AA1A1A1A" RenderTransformOrigin="0.5,0.5">
            <!-- 背景暂时保持硬编码或者使用 TextPrimaryBrush 配合透明度，这里为了遮罩效果使用半透明黑 -->
            <Grid.RenderTransform>
                <ScaleTransform ScaleX="1" ScaleY="1"/>
            </Grid.RenderTransform>
            <Rectangle Stroke="{DynamicResource TextInverseBrush}" StrokeThickness="3" RadiusX="20" RadiusY="20" Margin="40" StrokeDashArray="4 2"/>

            <!-- 文字和图标内容 -->
            <StackPanel VerticalAlignment="Center" HorizontalAlignment="Center">
                <!-- 图标 -->
                <Path x:Name="DragOverlayIcon" Width="64" Height="64" Fill="{DynamicResource TextInverseBrush}" Stretch="Uniform" Margin="0,0,0,20"
                      Data="M19,13H13V19H11V13H5V11H11V5H13V11H19V13Z" />

                <!-- 提示文字 -->
                <TextBlock x:Name="DragOverlayText" Text="拖放以打开" Foreground="{DynamicResource TextInverseBrush}" FontSize="28" FontWeight="Light" TextAlignment="Center"/>

                <!-- 副标题 -->
                <TextBlock x:Name="DragOverlaySubText" Text="释放鼠标以确认" Foreground="{DynamicResource BorderMediumBrush}" FontSize="16" Margin="0,10,0,0" TextAlignment="Center"/>
            </StackPanel>
        </Grid>
        <!-- #endregion -->
    </Grid>
</Window>
